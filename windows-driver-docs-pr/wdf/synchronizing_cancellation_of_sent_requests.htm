<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Synchronizing Cancellation of Sent Requests"/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Synchronizing Cancellation of Sent Requests</title>

<meta name="MS-HAID" content="Ch3_DFIoPackage_c61d7092-a414-449d-9dd4-98b748dd3ece.xml"/>
<meta name="MS-HAID" content="kmdf.synchronizing_cancellation_of_sent_requests"/>
<meta name="MS-HAID" content="wdf.synchronizing_cancellation_of_sent_requests"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.synchronizing_cancellation_of_sent_requests"></a>Synchronizing Cancellation of Sent Requests</h1>
</div>
<p>When a driver attempts to cancel an I/O request that it has forwarded to an I/O target, the driver must ensure that it passes a valid request handle to the <a href="wdf.wdfrequestcancelsentrequest"><b>WdfRequestCancelSentRequest</b></a> method. The request handle becomes invalid if the I/O target completes the request, because the driver's <a href="wdf.completionroutine"><i>CompletionRoutine</i></a> callback function will call <a href="wdf.wdfrequestcomplete"><b>WdfRequestComplete</b></a> (which attempts to delete the request object).</p>
<p>To avoid this problem, the driver can keep track of the requests that it has sent to the I/O target by, for example, creating a <a href="framework_object_collections.htm">collection</a> of request objects. The driver can call <a href="wdf.wdfspinlockacquire"><b>WdfSpinLockAcquire</b></a> to synchronize access to the collection.</p>
<p>When the driver's <a href="wdf.completionroutine"><i>CompletionRoutine</i></a> callback function is called, it acquires the lock, removes the completed request's handle from the collection, and calls <a href="wdf.wdfspinlockrelease"><b>WdfSpinLockRelease</b></a> to release the lock.</p>
<p>Before attempting to cancel a request that the driver has forwarded to an I/O target, the driver can:</p>
<ol>
<li>
<p>Call  <a href="wdf.wdfspinlockacquire"><b>WdfSpinLockAcquire</b></a> to acquire a spin lock.</p>
</li>
<li>
<p>Find the request object's handle in the collection, to ensure that driver's completion routine hasn't completed the request and removed the handle from the collection.</p>
</li>
<li>
<p>Call <a href="wdf.wdfobjectreference"><b>WdfObjectReference</b></a> to increment the request object's reference count so that the object cannot be deleted.</p>
</li>
<li>
<p>Call <a href="wdf.wdfspinlockrelease"><b>WdfSpinLockRelease</b></a> to release the spin lock.</p>
</li>
<li>
<p>Call <a href="wdf.wdfrequestcancelsentrequest"><b>WdfRequestCancelSentRequest</b></a>.</p>
</li>
<li>
<p>Call <a href="wdf.wdfobjectdereference"><b>WdfObjectDereference</b></a> to decrement the object's reference count.</p>
</li>
</ol>
<p>This sequence ensures that if the I/O target completes the request before the driver calls <a href="wdf.wdfrequestcancelsentrequest"><b>WdfRequestCancelSentRequest</b></a>, the request's handle is still valid (because of the incremented reference count) even if the driver's <a href="wdf.completionroutine"><i>CompletionRoutine</i></a> callback function calls <a href="wdf.wdfrequestcomplete"><b>WdfRequestComplete</b></a>.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Synchronizing Cancellation of Sent Requests%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
