<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="This topic describes how you can find driver memory leaks caused by unreleased references. It applies to User-Mode Driver Framework (UMDF) version 1 and 2 drivers."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Determining If a Driver Leaks Framework Objects</title>

<meta name="MS-HAID" content="umdfobjectdg_ccbaed64-ca33-4118-9265-8c4e72bc050a.xml"/>
<meta name="MS-HAID" content="umdf.determining_if_a_driver_leaks_framework_objects"/>
<meta name="MS-HAID" content="wdf.determining_if_a_driver_leaks_framework_objects"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.determining_if_a_driver_leaks_framework_objects"></a>Determining If a Driver Leaks Framework Objects</h1>
</div>
<p>This topic describes how you can find driver memory leaks caused by unreleased references. It applies to User-Mode Driver Framework (UMDF) version 1 and 2 drivers.</p>
<h2><a id="UMDF_1"></a><a id="umdf_1"></a>UMDF 1</h2>
<p>In UMDF version 1, a call stack can cause a memory leak if each call to <b>AddRef</b> does not have a matching <b>Release</b> call.</p>
<p>To test if your UMDF version 1 driver leaks framework objects, use the following steps:</p>
<ol>
<li>
<p>Use the <a href="devtest.wdf_verifier_control_application">WDF Verifier control application</a> to set the verifier options that you want.  During regular testing, start by setting <b>TrackObjects</b> and not <b>TrackRefCounts</b>.</p>
<p>When the driver is unloaded, the framework's code verifier enters the debugger if a framework object was not deleted, and it prompts you to use the <a href="using_umdf_debugger_extensions.htm"><b>!wudfdumpobjects</b></a> debugger extension. This debugger extension displays a list of undeleted objects.</p>
</li>
<li>
<p>If the code verifier indicates that the driver is leaking framework objects, then use the control application to set the <a href="using_umdf_verifier.htm"><b>TrackRefCounts</b></a> option. </p>
<p>If this option is set, the verifier keeps track of references to framework objects while the driver runs. You can use the <a href="using_umdf_debugger_extensions.htm"><b>!wudfrefhist</b></a> debugger extension   to display each call stack (set of function calls) that increments or decrements an object's reference count. By examining the <b>AddRef</b> and <b>Release</b> calls in these call stacks, you should be able to find a stack that does not decrement the object's reference count and thus causes the leak.</p>
</li>
</ol>
<p>For information about additional verifier options, see <a href="using_umdf_verifier.htm">Using UMDF Verifier</a>.</p>
<p>For information about when to delete framework objects, see <a href="managing_the_lifetime_of_objects.htm">Managing the Lifetime of Objects</a>.</p>
<h2><a id="UMDF_2"></a><a id="umdf_2"></a>UMDF 2</h2>
<p>In UMDF version 2, unreleased references are rare, but can occur due to call mismatches when using <a href="wdf.wdfobjectreference"><b>WdfObjectReference</b></a> and <a href="wdf.wdfobjectdereference"><b>WdfObjectDereference</b></a>.</p>
<p>To test if your UMDF version 2 driver leaks framework objects, use the following procedure:</p>
<ol>
<li>Follow the steps outlined in <a href="enabling_a_debugger.htm#bp">Best Practices</a> to configure your computer for UMDF debugging.</li>
<li>
<p>To use tag tracking, enable both the UMDF Verifier and handle tracking in the registry. Both of these settings are stored in the driver's <b>Parameters\Wdf</b> subkey of the <b>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\WUDF\Services\&lt;driver name&gt;</b> key.</p>
<p>

To enable the UMDF Verifier, set a nonzero value for <b>VerifierOn.</b></p>
<p>To enable handle tracking, set the value of <b>TrackHandles</b> to the name of one or more object types, or specify an asterisk (*) to track all object types.</p>
<p>You can also modify UMDF Verifier settings by using the <a href="devtest.wdf_verifier_control_application">WdfVerifier.exe</a> application.</p>
</li>
<li>
<p>Reboot, establish a debugger connection, and then use the following debugger commands:</p>
<ul>
<li><a href="debugger._wdfkd_wdfdriverinfo"><b>!wdfkd.wdfdriverinfo 0x10</b></a> to display the handle hierarchy</li>
<li><a href="debugger._wdfkd_wdftagtracker"><b>!wdfkd.wdftagtracker</b></a> to display tag information</li>
</ul>
</li>
</ol>
<p>If UMDF Verifier is on, memory leaks are detected at driver unload, just as in KMDF.</p>
<p>For additional information about using reference counts in KMDF and UMDF version 2 drivers, see <a href="framework_object_life_cycle.htm">Framework Object Life Cycle</a>.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Determining If a Driver Leaks Framework Objects%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
