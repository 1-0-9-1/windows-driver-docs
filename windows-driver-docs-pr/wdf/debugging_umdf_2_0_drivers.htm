<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Starting in User-Mode Driver Framework (UMDF) version 2, you can use a subset of the debugger extension commands implemented in Wdfkd.dll to debug a UMDF driver."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Troubleshooting UMDF 2.0 Driver Crashes</title>

<meta name="MS-HAID" content="wdf.debugging_umdf_2_0_drivers"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.debugging_umdf_2_0_drivers"></a>Troubleshooting UMDF 2.0 Driver Crashes</h1>
</div>
<p>Starting in User-Mode Driver Framework (UMDF) version 2, you can use a subset of the debugger extension commands implemented in Wdfkd.dll to debug a UMDF driver. This topic describes which commands you might start with to troubleshoot UMDF driver problems.</p>
<h2><a id="_Determining_Why_a_UMDF_2.0_Driver_Crashed"></a><a id="_determining_why_a_umdf_2.0_driver_crashed"></a><a id="_DETERMINING_WHY_A_UMDF_2.0_DRIVER_CRASHED"></a>	Determining Why a UMDF 2.0 Driver Crashed</h2>
<p>If the driver host process is terminated, your driver might have a problem in a callback that results in the <a href="how_umdf_enforces_time_outs.htm">host timeout</a> threshold being exceeded. In this case, the reflector terminates the driver host process.</p>
<p>To investigate, first set up a kernel-mode debugging session as described in <a href="enabling_a_debugger.htm">How to Enable Debugging of a UMDF Driver</a>.</p>
<ul>
<li>
<p>If <b>HostFailKdDebugBreak</b> is set, the reflector breaks into the kernel-mode debugger when the timeout threshold is exceeded. In the debugger output, you will see several suggestions on how to begin, including links you can click on. For example:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>**** Problem detected in UMDF driver "WUDFOsrUsbFx2". !process 0xFFFFE0000495B080 0x1f, !devstack 0xFFFFE000032BFA10, Problem code 3 ****
**** Dump UMDF driver image name and stack: !wdfkd.wdfumdevstack 0x000000BEBB49AE20
**** Dump UM Irps for this stack: !wdfkd.wdfumirps 0x000000BEBB49AE20
**** Dump UMDF trace log: !wmitrace.logdump WUDFTrace
**** Helpful UMDF debugger extension commands: !wdfkd.wdfhelp
**** Note that driver host process may get terminated if you go past this break, making it difficult to debug the problem!

</pre>
</td>
</tr>
</table></span></div>
</li>
<li>Use <a href="debugger._analyze"><b>!analyze</b></a> to display information about the failure, and additional UMDF extension commands you can try.</li>
<li>
<p>Use <a href="debugger._process"><b>!process 0 0x1f wudfhost.exe</b></a> to list all Wudfhost.exe driver host processes, including thread stack information.</p>
<p>You can also use <a href="debugger._wdfkd_wdfldr"><b>!wdfkd.wdfldr</b></a> to display all drivers that are currently bound to WDF. When you click on the  image name of a UMDF driver, the debugger displays the address of the hosting process. You can then click on the process address to display information specific to that process.</p>
</li>
<li>If necessary, use <a href="debugger._process__set_process_context_"><b>.process /r /p <i>Process</i></b></a> to switch process context to that of the Wudfhost process that is hosting your driver. Use  <a href="debugger._cache__set_cache_size_"><b>.cache forcedecodeuser</b></a> and <b>lmu</b> to verify that your driver is hosted in the current  process.</li>
<li>Examine thread call stacks (<a href="debugger._thread"><b>!thread <i>Address</i></b></a>) to determine if a driver callback timed out.  Look at the tick count for the threads.  In Windows 8.1, the reflector times out after one minute.</li>
<li>Use <a href="debugger._wdfkd_wdfdriverinfo"><b>!wdfkd.wdfdriverinfo MyDriver.dll 0x10</b></a> to display the device tree in verbose form. Then click on <a href="debugger._wdfkd_wdfdevice"><b>!wdfdevice</b></a>. This command displays detailed power, power policy, and Plug and Play (PnP) state information.</li>
<li>Use <a href="debugger._wdfkd_wdfumirps"><b>!wdfkd.wdfumirps</b></a> to look for pending IRPs.</li>
<li>Use <a href="debugger._wdfkd_wdfdevicequeues"><b>!wdfkd.wdfdevicequeues</b></a> to check the status of the driver's queues.</li>
<li>In a kernel-mode debugging session, you can use <a href="debugger._wmitrace_logdump"><b>!wmitrace.logdump WudfTrace</b></a> to display the trace log.</li>
</ul>
<h2><a id="Displaying_the__UMDF_2.0_IFR_Log"></a><a id="displaying_the__umdf_2.0_ifr_log"></a><a id="DISPLAYING_THE__UMDF_2.0_IFR_LOG"></a>Displaying the  UMDF 2.0 IFR Log</h2>
<p>In a kernel-mode debugging session, you can use the <a href="debugger._wdfkd_wdflogdump"><b>!wdfkd.wdflogdump</b></a> extension command to display the Windows Driver Frameworks (WDF) In-flight Recorder (IFR) log records, if available.</p>
<h2><a id="Finding_Memory_Dump_Files"></a><a id="finding_memory_dump_files"></a><a id="FINDING_MEMORY_DUMP_FILES"></a>Finding Memory Dump Files</h2>
<p>See <a href="determining_why_the_reflector_terminated_the_host_process.htm">Determining Why the Reflector Terminated the Host Process</a> for information on finding user-mode dump files. See <a href="using_wpp_software_tracing_in_umdf_drivers.htm">Using WPP Software Tracing in UMDF Drivers</a> for information on how to set the <b>LogMinidumpType</b> registry value to specify the type of information stored in the minidump file.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Troubleshooting UMDF 2.0 Driver Crashes%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
