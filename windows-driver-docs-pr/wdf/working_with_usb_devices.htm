<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="This topic describes the operations that a Kernel-Mode Driver Framework (KMDF) or User-Mode Driver Framework (UMDF) driver starting in version 2 can perform using the USB device object methods provided by Windows Driver Frameworks (WDF)."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Working with USB Devices</title>

<meta name="MS-HAID" content="Ch6_DFUSBPackage_ddc0b592-7572-4a42-b66a-a7abc701db4b.xml"/>
<meta name="MS-HAID" content="kmdf.working_with_usb_devices"/>
<meta name="MS-HAID" content="wdf.working_with_usb_devices"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.working_with_usb_devices"></a>Working with USB Devices</h1>
</div>
<p>This topic describes the operations that a Kernel-Mode Driver Framework (KMDF) or User-Mode Driver Framework (UMDF) driver starting in version 2 can perform using the USB device object methods provided by Windows Driver Frameworks (WDF).</p>
<p>It contains the following sections:</p>
<p>
<ul>
<li><a href="#creating_a_framework_usb_device_object">
      Creating a USB device object</a></li>
<li><a href="#selecting_a_device_configuration">Configuring a USB Device</a></li>
<li><a href="#obtaining_device_information">
      Obtaining Device Information</a></li>
<li><a href="#obtaining_a_device_s_unicode_strings">Getting USB Descriptors</a></li>
<li><a href="#sending_a_control_transfer">
      Sending a Control Transfer</a></li>
<li><a href="#resetting_and_power_cycling_a_device_s_port">
      Resetting and Power-Cycling a Device's Port</a></li>
<li><a href="#sending_a_urb_to_a_device">
      Sending an URB to a Device</a></li>
</ul>
</p>
<p>For step-by-step directions on writing a simple KMDF-based USB  client driver, see <a href="buses.tutorial__write_your_first_usb_client_driver__kmdf_">How to write your first USB client driver (KMDF)</a>.</p>
<h2><a id="creating_a_framework_usb_device_object"></a><a id="CREATING_A_FRAMEWORK_USB_DEVICE_OBJECT"></a>
      Creating a USB device object</h2>
<p>To use the framework's USB I/O target objects (WDFUSBDEVICE, WDFUSBINTERFACE, and WDFUSBPIPE), your client driver must first call <a href="wdf.wdfusbtargetdevicecreatewithparameters"><b>WdfUsbTargetDeviceCreateWithParameters</b></a> to create a USB device object.  Typically, a driver calls <b>WdfUsbTargetDeviceCreateWithParameters</b> from its  <a href="wdf.evtdevicepreparehardware"><i>EvtDevicePrepareHardware</i></a> callback function.</p>
<p> When the driver calls <a href="wdf.wdfusbtargetdevicecreatewithparameters"><b>WdfUsbTargetDeviceCreateWithParameters</b></a>, the framework creates a WDFUSBDEVICE object and associates it with the FDO that represents the USB device.  The method returns a handle to the new framework USB device object that the USB client driver can then use to communicate with the physical device.</p>
<p>After calling <a href="wdf.wdfusbtargetdevicecreatewithparameters"><b>WdfUsbTargetDeviceCreateWithParameters</b></a>, the driver can call <a href="wdf.wdfusbtargetdevicegetdevicedescriptor"><b>WdfUsbTargetDeviceGetDeviceDescriptor</b></a> and <a href="wdf.wdfusbtargetdeviceretrieveconfigdescriptor"><b>WdfUsbTargetDeviceRetrieveConfigDescriptor</b></a> to obtain USB descriptors from the device. Those descriptors contain information about the device's first configuration, its interface settings, and their defined endpoints. (The USB descriptors are defined in the official USB specification.)</p>
<h2><a id="selecting_a_device_configuration"></a><a id="SELECTING_A_DEVICE_CONFIGURATION"></a>Configuring a USB Device</h2>
<p>The <a href="wdf.wdfusbtargetdevicecreatewithparameters"><b>WdfUsbTargetDeviceCreateWithParameters</b></a> method also creates a framework USB interface object for each USB interface that the device's first configuration contains.</p>
<p>After calling <a href="wdf.wdfusbtargetdevicecreatewithparameters"><b>WdfUsbTargetDeviceCreateWithParameters</b></a>, the client driver must call <a href="wdf.wdfusbtargetdeviceselectconfig"><b>WdfUsbTargetDeviceSelectConfig</b></a> to select a configuration. This method creates framework interface objects for each alternate setting of the interface in the selected configuration.</p>
<p>The method also creates pipe objects that represent endpoints defined in each alternate setting of each interface of the selected configuration.</p>
<p>After you have selected a configuration, you can <a href="working_with_usb_interfaces.htm#selecting_an_alternate_setting_for_a_usb_interface">change alternate settings</a> for the configuration's interfaces, if necessary.</p>
<p>You can also call <a href="wdf.wdfusbtargetdeviceselectconfig"><b>WdfUsbTargetDeviceSelectConfig</b></a> to deconfigure a device.</p>
<p>For related information, see:</p>
<ul>
<li><a href="buses.how_to_select_a_configuration_for_a_usb_device">How to select a configuration for a USB device</a></li>
<li><a href="buses.select_a_usb_alternate_setting">How to select an alternate setting in a USB interface</a></li>
</ul>
<h2><a id="obtaining_device_information"></a><a id="OBTAINING_DEVICE_INFORMATION"></a>
      Obtaining Device Information</h2>
<p>After configuring a device, your client driver can call the following methods to obtain information about a USB device:</p>
<p></p>
<dl>
<dt><a id="WdfUsbTargetDeviceQueryUsbCapability"></a><a id="wdfusbtargetdevicequeryusbcapability"></a><a id="WDFUSBTARGETDEVICEQUERYUSBCAPABILITY"></a><a href="wdf.wdfusbtargetdevicequeryusbcapability"><b>WdfUsbTargetDeviceQueryUsbCapability</b></a></dt>
<dd>
<p>Determines whether the host controller and USB driver stack support a specific capability. Before calling <a href="wdf.wdfusbtargetdevicequeryusbcapability"><b>WdfUsbTargetDeviceQueryUsbCapability</b></a>, a driver must call <a href="wdf.wdfusbtargetdevicecreatewithparameters"><b>WdfUsbTargetDeviceCreateWithParameters</b></a>.</p>
</dd>
<dt><a id="WdfUsbTargetDeviceGetIoTarget"></a><a id="wdfusbtargetdevicegetiotarget"></a><a id="WDFUSBTARGETDEVICEGETIOTARGET"></a><a href="wdf.wdfusbtargetdevicegetiotarget"><b>WdfUsbTargetDeviceGetIoTarget</b></a></dt>
<dd>
<p>Returns a handle to the I/O target object that is associated with a USB device. The driver can pass this handle to <a href="wdf.wdfrequestsend"><b>WdfRequestSend</b></a> or <a href="wdf.wdfiotargetstop"><b>WdfIoTargetStop</b></a>.</p>
</dd>
<dt><a id="WdfUsbTargetDeviceRetrieveInformation"></a><a id="wdfusbtargetdeviceretrieveinformation"></a><a id="WDFUSBTARGETDEVICERETRIEVEINFORMATION"></a><a href="wdf.wdfusbtargetdeviceretrieveinformation"><b>WdfUsbTargetDeviceRetrieveInformation</b></a></dt>
<dd>
<p>Retrieves version and capability information that is associated with a USB device.</p>
</dd>
<dt><a id="WdfUsbTargetDeviceIsConnectedSynchronous__KMDF_only_"></a><a id="wdfusbtargetdeviceisconnectedsynchronous__kmdf_only_"></a><a id="WDFUSBTARGETDEVICEISCONNECTEDSYNCHRONOUS__KMDF_ONLY_"></a><a href="wdf.wdfusbtargetdeviceisconnectedsynchronous"><b>WdfUsbTargetDeviceIsConnectedSynchronous (KMDF only)</b></a></dt>
<dd>
<p>Determines if the device is connected.</p>
</dd>
<dt><a id="WdfUsbTargetDeviceRetrieveCurrentFrameNumber__KMDF_only_"></a><a id="wdfusbtargetdeviceretrievecurrentframenumber__kmdf_only_"></a><a id="WDFUSBTARGETDEVICERETRIEVECURRENTFRAMENUMBER__KMDF_ONLY_"></a><a href="wdf.wdfusbtargetdeviceretrievecurrentframenumber"><b>WdfUsbTargetDeviceRetrieveCurrentFrameNumber (KMDF only)</b></a></dt>
<dd>
<p>Retrieves the current USB frame number.</p>
</dd>
</dl>
<h2><a id="obtaining_a_device_s_unicode_strings"></a><a id="OBTAINING_A_DEVICE_S_UNICODE_STRINGS"></a>Getting USB Descriptors</h2>
<p>To obtain the Unicode strings that are contained in a USB device's descriptors, the driver can call any of the following methods:</p>
<p></p>
<dl>
<dt><a id="WdfUsbTargetDeviceGetDeviceDescriptor"></a><a id="wdfusbtargetdevicegetdevicedescriptor"></a><a id="WDFUSBTARGETDEVICEGETDEVICEDESCRIPTOR"></a><a href="wdf.wdfusbtargetdevicegetdevicedescriptor"><b>WdfUsbTargetDeviceGetDeviceDescriptor</b></a></dt>
<dd>
<p>Obtains a device's <a href="buses.usb_device_descriptors">USB device descriptor</a>.</p>
</dd>
<dt><a id="WdfUsbTargetDeviceRetrieveConfigDescriptor"></a><a id="wdfusbtargetdeviceretrieveconfigdescriptor"></a><a id="WDFUSBTARGETDEVICERETRIEVECONFIGDESCRIPTOR"></a><a href="wdf.wdfusbtargetdeviceretrieveconfigdescriptor"><b>WdfUsbTargetDeviceRetrieveConfigDescriptor</b></a></dt>
<dd>
<p>Obtains a device's <a href="buses.usb_configuration_descriptors">USB configuration descriptor</a>, interface descriptors, and endpoint descriptors.</p>
</dd>
<dt><a id="_________WdfUsbTargetDeviceQueryString________"></a><a id="_________wdfusbtargetdevicequerystring________"></a><a id="_________WDFUSBTARGETDEVICEQUERYSTRING________"></a><a href="wdf.wdfusbtargetdevicequerystring"><b>
        WdfUsbTargetDeviceQueryString
       </b></a></dt>
<dd>
<p>Copies a Unicode string to a driver-supplied buffer. </p>
</dd>
<dt><a id="_________WdfUsbTargetDeviceAllocAndQueryString________"></a><a id="_________wdfusbtargetdeviceallocandquerystring________"></a><a id="_________WDFUSBTARGETDEVICEALLOCANDQUERYSTRING________"></a><a href="wdf.wdfusbtargetdeviceallocandquerystring"><b>
        WdfUsbTargetDeviceAllocAndQueryString
       </b></a></dt>
<dd>
<p>Copies a Unicode string to a framework-supplied buffer.</p>
</dd>
<dt><a id="_________WdfUsbTargetDeviceFormatRequestForString________"></a><a id="_________wdfusbtargetdeviceformatrequestforstring________"></a><a id="_________WDFUSBTARGETDEVICEFORMATREQUESTFORSTRING________"></a><a href="wdf.wdfusbtargetdeviceformatrequestforstring"><b>
        WdfUsbTargetDeviceFormatRequestForString
       </b></a></dt>
<dd>
<p>Formats a request for a Unicode string. The driver can call <a href="wdf.wdfrequestsend"><b>WdfRequestSend</b></a> to send the request synchronously or asynchronously.</p>
</dd>
</dl>
<h2><a id="sending_a_control_transfer"></a><a id="SENDING_A_CONTROL_TRANSFER"></a>
      Sending a Control Transfer</h2>
<p>Your driver can call the following methods to send an I/O request that describes a standard, device class-specific, or vendor-specific USB control transfer.</p>
<p></p>
<dl>
<dt><a id="_________WdfUsbTargetDeviceSendControlTransferSynchronously________"></a><a id="_________wdfusbtargetdevicesendcontroltransfersynchronously________"></a><a id="_________WDFUSBTARGETDEVICESENDCONTROLTRANSFERSYNCHRONOUSLY________"></a><a href="wdf.wdfusbtargetdevicesendcontroltransfersynchronously"><b>
        WdfUsbTargetDeviceSendControlTransferSynchronously
       </b></a></dt>
<dd>
<p>Synchronously sends a USB control transfer request. </p>
</dd>
<dt><a id="_________WdfUsbTargetDeviceFormatRequestForControlTransfer________"></a><a id="_________wdfusbtargetdeviceformatrequestforcontroltransfer________"></a><a id="_________WDFUSBTARGETDEVICEFORMATREQUESTFORCONTROLTRANSFER________"></a><a href="wdf.wdfusbtargetdeviceformatrequestforcontroltransfer"><b>
        WdfUsbTargetDeviceFormatRequestForControlTransfer
       </b></a></dt>
<dd>
<p>Formats a request for a USB control transfer. The driver can call <a href="wdf.wdfrequestsend"><b>WdfRequestSend</b></a> to send the request synchronously or asynchronously.</p>
</dd>
</dl>
<p>For related information, see <a href="buses.usb_control_transfer">How to send a USB control transfer</a>.</p>
<h2><a id="resetting_and_power_cycling_a_device_s_port"></a><a id="RESETTING_AND_POWER_CYCLING_A_DEVICE_S_PORT"></a>
      Resetting and Power-Cycling a Device's Port</h2>
<p>Your driver can call the following methods to reset or power-cycle the USB port that a device is connected to:</p>
<p></p>
<dl>
<dt><a id="_________WdfUsbTargetDeviceResetPortSynchronously"></a><a id="_________wdfusbtargetdeviceresetportsynchronously"></a><a id="_________WDFUSBTARGETDEVICERESETPORTSYNCHRONOUSLY"></a><a href="wdf.wdfusbtargetdeviceresetportsynchronously"><b>
        WdfUsbTargetDeviceResetPortSynchronously</b></a></dt>
<dd>
<p>Synchronously sends a request to reset a device's USB port.</p>
</dd>
<dt><a id="_________WdfUsbTargetDeviceCyclePortSynchronously__KMDF_only_"></a><a id="_________wdfusbtargetdevicecycleportsynchronously__kmdf_only_"></a><a id="_________WDFUSBTARGETDEVICECYCLEPORTSYNCHRONOUSLY__KMDF_ONLY_"></a><a href="wdf.wdfusbtargetdevicecycleportsynchronously"><b>
        WdfUsbTargetDeviceCyclePortSynchronously (KMDF only)</b></a></dt>
<dd>
<p>Synchronously sends a request to power-cycle a device's USB port.</p>
</dd>
<dt><a id="_________WdfUsbTargetDeviceFormatRequestForCyclePort__KMDF_only_"></a><a id="_________wdfusbtargetdeviceformatrequestforcycleport__kmdf_only_"></a><a id="_________WDFUSBTARGETDEVICEFORMATREQUESTFORCYCLEPORT__KMDF_ONLY_"></a><a href="wdf.wdfusbtargetdeviceformatrequestforcycleport"><b>
        WdfUsbTargetDeviceFormatRequestForCyclePort (KMDF only)</b></a></dt>
<dd>
<p>Formats a request to power-cycle a device's USB port. The driver must call <a href="wdf.wdfrequestsend"><b>WdfRequestSend</b></a> to send the request synchronously or asynchronously.</p>
</dd>
</dl>
<p>For related information, see <a href="buses.how_to_recover_from_usb_pipe_errors">How to recover from USB pipe errors</a>.</p>
<h2><a id="sending_a_urb_to_a_device"></a><a id="SENDING_A_URB_TO_A_DEVICE"></a>
      Sending an URB to a Device</h2>
<p>If your KMDF driver communicates with its USB device by sending I/O requests that contain URBs, the driver can call the following methods:</p>
<p></p>
<dl>
<dt><a id="WdfUsbTargetDeviceCreateUrb__KMDF_only_"></a><a id="wdfusbtargetdevicecreateurb__kmdf_only_"></a><a id="WDFUSBTARGETDEVICECREATEURB__KMDF_ONLY_"></a><a href="wdf.wdfusbtargetdevicecreateurb"><b>WdfUsbTargetDeviceCreateUrb (KMDF only)</b></a></dt>
<dd>
<p>Allocates a USB request block (URB). Before calling <a href="wdf.wdfusbtargetdevicecreateurb"><b>WdfUsbTargetDeviceCreateUrb</b></a>, a driver must call <a href="wdf.wdfusbtargetdevicecreatewithparameters"><b>WdfUsbTargetDeviceCreateWithParameters</b></a>.</p>
</dd>
<dt><a id="WdfUsbTargetDeviceCreateIsochUrb__KMDF_only_"></a><a id="wdfusbtargetdevicecreateisochurb__kmdf_only_"></a><a id="WDFUSBTARGETDEVICECREATEISOCHURB__KMDF_ONLY_"></a><a href="wdf.wdfusbtargetdevicecreateisochurb"><b>WdfUsbTargetDeviceCreateIsochUrb (KMDF only)</b></a></dt>
<dd>
<p>Allocates an isochronous USB request block (URB). Before calling <a href="wdf.wdfusbtargetdevicecreateisochurb"><b>WdfUsbTargetDeviceCreateIsochUrb</b></a>, a driver must call <a href="wdf.wdfusbtargetdevicecreatewithparameters"><b>WdfUsbTargetDeviceCreateWithParameters</b></a>.</p>
</dd>
<dt><a id="_________WdfUsbTargetDeviceSendUrbSynchronously__KMDF_only_"></a><a id="_________wdfusbtargetdevicesendurbsynchronously__kmdf_only_"></a><a id="_________WDFUSBTARGETDEVICESENDURBSYNCHRONOUSLY__KMDF_ONLY_"></a><a href="wdf.wdfusbtargetdevicesendurbsynchronously"><b>
        WdfUsbTargetDeviceSendUrbSynchronously (KMDF only)</b></a></dt>
<dd>
<p>Synchronously sends an I/O request that contains an URB.</p>
</dd>
<dt><a id="_________WdfUsbTargetDeviceFormatRequestForUrb__KMDF_only_"></a><a id="_________wdfusbtargetdeviceformatrequestforurb__kmdf_only_"></a><a id="_________WDFUSBTARGETDEVICEFORMATREQUESTFORURB__KMDF_ONLY_"></a><a href="wdf.wdfusbtargetdeviceformatrequestforurb"><b>
        WdfUsbTargetDeviceFormatRequestForUrb (KMDF only)</b></a></dt>
<dd>
<p>Formats an I/O request that contains a URB. The driver must call <a href="wdf.wdfrequestsend"><b>WdfRequestSend</b></a> to send the request synchronously or asynchronously.</p>
</dd>
<dt><a id="_________WdfUsbTargetDeviceWdmGetConfigurationHandle__KMDF_only_"></a><a id="_________wdfusbtargetdevicewdmgetconfigurationhandle__kmdf_only_"></a><a id="_________WDFUSBTARGETDEVICEWDMGETCONFIGURATIONHANDLE__KMDF_ONLY_"></a><a href="wdf.wdfusbtargetdevicewdmgetconfigurationhandle"><b>
        WdfUsbTargetDeviceWdmGetConfigurationHandle (KMDF only)</b></a></dt>
<dd>
<p>Returns a device's USBD configuration handle. Some URBs require this handle. </p>
</dd>
</dl>
<p>For general conceptual background on URBs, see <a href="buses.how_to_add_xrb_support_for_client_drivers">Allocating and Building URBs</a>.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Working with USB Devices%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
