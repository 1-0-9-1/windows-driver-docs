<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Porting I/O Dispatch Routines to I/O Event Callback Functions"/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Porting I/O Dispatch Routines to I/O Event Callback Functions</title>

<meta name="MS-HAID" content="kmdf.porting_i_o_dispatch_routines_to_i_o_event_callback_functions"/>
<meta name="MS-HAID" content="wdf.porting_i_o_dispatch_routines_to_i_o_event_callback_functions"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.porting_i_o_dispatch_routines_to_i_o_event_callback_functions"></a>Porting I/O Dispatch Routines to I/O Event Callback Functions</h1>
</div>
<p>The core of a WDM driver’s I/O dispatch routines maps to the WDF driver’s I/O event callback functions. However, the I/O event callback functions differ in several important ways from a WDM driver’s I/O dispatch routines:</p>
<ul>
<li>When the framework invokes a WDF driver’s I/O event callback, the callback receives the request in a noncancelable state. The request cannot be canceled unless the driver explicitly marks it as cancelable.</li>
<li>The driver specifies whether the framework synchronizes calls to the I/O event callbacks so that only one such callback runs concurrently for each queue or for each device object, or whether the framework applies no synchronization at all. For more information about selecting synchronization options, see <a href="using_automatic_synchronization.htm">Using Automatic Synchronization</a>.</li>
</ul>
<p>These differences mean that most I/O event callback functions contain significantly less code to synchronize access and to prevent race conditions than the corresponding WDM <b>DispatchXxx</b> routines.</p>
<p>Aside from synchronization, the primary differences between a WDM driver’s I/O dispatch routines and a WDF driver’s I/O event callback functions lie in how the driver retrieves parameters and how it accesses I/O buffers.
</p>
<h2><a id="Parameters_for_I_O_Requests"></a><a id="parameters_for_i_o_requests"></a><a id="PARAMETERS_FOR_I_O_REQUESTS"></a>Parameters for I/O Requests</h2>
<p>Depending on the types of requests that a WDF driver handles and the way it configures its I/O queues, a driver might not be required to parse the parameters to an I/O request as a WDM driver does. When the framework calls the I/O event callbacks for read, write, and device I/O control requests (<a href="wdf.evtioread"><i>EvtIoRead</i></a>, <a href="wdf.evtiowrite"><i>EvtIoWrite</i></a>, <a href="wdf.evtiodevicecontrol"><i>EvtIoDeviceControl</i></a>, <a href="wdf.evtiointernaldevicecontrol"><i>EvtIoInternalDeviceControl</i></a>), it extracts the most commonly used parameters from the IRP and passes them as parameters to the callback. For example, the framework calls a driver’s <i>EvtIoRead</i> callback with a handle to the WDFREQUEST object and the number of bytes to read. If the driver does not require a device offset or a sort key, it can simply retrieve the buffer from the WDFREQUEST object by calling one of the <b>WdfRequestRetrieveOutput</b><b>Xxx</b> methods; it does not need to retrieve additional parameters.</p>
<p>In an <b>EvtIoDefault</b> callback, however, the framework passes only a handle to the queue and a handle to the request object. Consequently, the driver must call <b>WdfRequestGetParameters</b> to get the parameters, including the type of request (<b>WdfRequestType</b><b>Xxx</b>). <a href="wdf.wdfrequestgetparameters"><b>WdfRequestGetParameters</b></a> returns a <a href="wdf.wdf_request_parameters"><b>WDF_REQUEST_PARAMETERS</b></a> structure that contains the parameters that were passed with a create, read, write, device I/O control, or internal device I/O control request.</p>
<h2><a id="Access_to_Buffers_for_Buffered_and_Direct_I_O"></a><a id="access_to_buffers_for_buffered_and_direct_i_o"></a><a id="ACCESS_TO_BUFFERS_FOR_BUFFERED_AND_DIRECT_I_O"></a>Access to Buffers for Buffered and Direct I/O</h2>
<p>When the framework receives a request for I/O, it creates a WDFREQUEST object that encapsulates the underlying WDM IRP. It then queues the WDFREQUEST object and eventually dispatches it according to the driver’s <a href="dispatching_methods_for_i_o_requests.htm">dispatch specification</a> for the queue. The driver uses WDF methods to retrieve parameters and buffers for the I/O request. A driver can get the underlying WDM IRP at any time by calling <a href="wdf.wdfrequestwdmgetirp"><b>WdfRequestWdmGetIrp</b></a>.</p>
<p>Like WDM drivers, WDF drivers can support <a href="wdf.accessing_data_buffers_in_kmdf_drivers">buffered, direct, or neither I/O</a>. A driver sets the type of I/O that is supported for each device object by calling <a href="wdf.wdfdeviceinitsetiotype"><b>WdfDeviceInitSetIoType</b></a> in the <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a> callback before creating the device object. Unlike a WDM driver, however, a KMDF driver accesses the buffers in the same way whether it performs buffered or direct I/O and uses the same methods for each. </p>
<p>Although a WDF driver accesses buffers in the same way for both buffered and direct I/O, it uses different methods to retrieve the buffers depending on the type of I/O request. The following sections describe how the driver handles each type of I/O request:</p>
<ul>
<li><a href="#create_requests">Create Requests</a></li>
<li><a href="#read_requests">Read Requests</a></li>
<li><a href="#write_requests">Write Requests</a></li>
<li><a href="#device_i_o_requests">Device I/O Control Requests</a></li>
<li><a href="#int_dev_i_o">Internal Device I/O Control Requests</a></li>
</ul>
<h2><a id="create_requests"></a><a id="CREATE_REQUESTS"></a>Create Requests</h2>
<p>A WDF driver can handle create requests (<a href="kernel.irp_mj_create"><b>IRP_MJ_CREATE</b></a>) in one of two ways:</p>
<ul>
<li>Bypass queuing and instead supply an <a href="wdf.evtdevicefilecreate"><i>EvtDeviceFileCreate</i></a> callback.</li>
<li>Have the framework queue create requests and implement an <a href="wdf.evtiodefault"><i>EvtIoDefault</i></a> callback to handle such requests from the queue.</li>
</ul>
<p>
For detailed information about handling file creation requests, see <a href="framework_file_objects.htm#creating_or_opening_a_file">Framework File Objects</a>.</p>
<h2><a id="read_requests"></a><a id="READ_REQUESTS"></a>Read Requests</h2>
<p>To retrieve a buffer for a read request (<a href="kernel.irp_mj_read"><b>IRP_MJ_READ</b></a>), a WDF driver calls one of the <b>WdfRequestRetrieveOutput</b><b>Xxx</b> methods. The buffer that each of these methods returns depends on whether the driver performs <a href="wdf.accessing_data_buffers_in_kmdf_drivers">buffered, direct, or neither I/O</a>.</p>
<p>For information about WDM equivalents for buffer pointers, see <a href="wdm_equivalents_for_kmdf_buffer_pointers.htm#read">WDM Equivalents for KMDF Buffer Pointers</a>.</p>
<h2><a id="write_requests"></a><a id="WRITE_REQUESTS"></a>Write Requests</h2>
<p>To retrieve a buffer for a write request (<a href="kernel.irp_mj_write"><b>IRP_MJ_WRITE</b></a>), a WDF driver calls one of the <b>WdfRequestRetrieveInput</b><b>Xxx</b> methods. The buffer that each of these methods returns depends on whether the driver performs <a href="wdf.accessing_data_buffers_in_kmdf_drivers">buffered, direct, or neither I/O</a>.</p>
<p>For information about WDM equivalents for buffer pointers, see <a href="wdm_equivalents_for_kmdf_buffer_pointers.htm#write">WDM Equivalents for KMDF Buffer Pointers</a>.</p>
<h2><a id="device_i_o_requests"></a><a id="DEVICE_I_O_REQUESTS"></a>Device I/O Control Requests</h2>
<p>To handle a device I/O control request (<a href="kernel.irp_mj_device_control"><b>IRP_MJ_DEVICE_CONTROL</b></a>), a WDF driver calls either <b>WdfRequestRetrieveInput</b><b>Xxx</b> methods or <b>WdfRequestRetrieveOutput</b><b>Xxx</b> methods to get buffers for buffered and direct I/O. The corresponding input and output methods return the same buffer, so the driver can use either one. The buffer that each of these methods returns depends on whether the driver performs <a href="wdf.accessing_data_buffers_in_kmdf_drivers">buffered, direct, or neither I/O</a>, just as in read and write requests.</p>
<p>If the driver handles device I/O control requests that originate in another device stack or use the <b>Parameters.Other</b> fields, the driver should call <a href="wdf.wdfrequestgetparameters"><b>WdfRequestGetParameters</b></a> to get a buffer pointer instead of calling <a href="wdf.wdfrequestretrieveinputbuffer"><b>WdfRequestRetrieveInputBuffer</b></a> and <a href="wdf.wdfrequestretrieveoutputbuffer"><b>WdfRequestRetrieveOutputBuffer</b></a>. Because the source of these requests is guaranteed to be a kernel-mode component, the driver can trust the returned buffer pointer. However, it must still validate the buffer lengths and any other parameters.</p>
<p>For information about WDM equivalents for buffer pointers, see <a href="wdm_equivalents_for_kmdf_buffer_pointers.htm#device_control">WDM Equivalents for KMDF Buffer Pointers</a>.</p>
<h2><a id="int_dev_i_o"></a><a id="INT_DEV_I_O"></a>Internal Device I/O Control Requests</h2>
<p>Internal device I/O control requests (<a href="kernel.irp_mj_internal_device_control"><b>IRP_MJ_INTERNAL_DEVICE_CONTROL</b></a>) are issued only by kernel-mode components and are used internally by some operating system components to pass request blocks (xRB protocols such as SCSI request blocks [SRBs] or universal request blocks [URBs]). Many different types of buffers can accompany such requests.</p>
<p>Retrieving and interpreting parameters for internal device I/O control requests can be problematic. The problem occurs because some such requests pass the length in the <b>InputBufferLength</b> and <b>OutputBufferLength</b> fields of the <b>Parameters.DeviceIoControl</b> structure of the WDM IRP, but some do not. Nevertheless, the framework extracts whatever values are in the <b>InputBufferLength</b> and <b>OutputBufferLength</b> fields and passes them as parameters to the <a href="wdf.evtiointernaldevicecontrol"><i>EvtIoInternalDeviceControl</i></a> callback. It does not perform any internal validation on these values.</p>
<p>To get the buffers themselves, the driver calls one of the following methods:  </p>
<ul>
<li><a href="wdf.wdfrequestretrieveinputbuffer"><b>WdfRequestRetrieveInputBuffer</b></a>, which returns the <b>Parameters.DeviceIoControl.Type3InputBuffer</b> field of the IRP.</li>
<li><a href="wdf.wdfrequestretrieveoutputbuffer"><b>WdfRequestRetrieveOutputBuffer</b></a>, which returns the <b>UserBuffer</b> field of the IRP.</li>
</ul>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Porting I/O Dispatch Routines to I/O Event Callback Functions%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
