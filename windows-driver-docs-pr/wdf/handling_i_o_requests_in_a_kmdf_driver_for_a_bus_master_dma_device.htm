<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="This topics in this section describe how a KMDF driver for a bus-master DMA device processes an I/O request. If you are writing a KMDF driver that implements system-mode DMA, see Supporting System-Mode DMA."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Handling I/O Requests in a KMDF Driver for a Bus-Master DMA Device</title>

<meta name="MS-HAID" content="DFDmaPackage_cbf908f3-a2a2-4966-913d-04328e4367bc.xml"/>
<meta name="MS-HAID" content="kmdf.handling_i_o_requests_for_a_dma_device"/>
<meta name="MS-HAID" content="kmdf.handling_i_o_requests_in_a_kmdf_driver_for_a_bus_master_dma_device"/>
<meta name="MS-HAID" content="wdf.handling_i_o_requests_in_a_kmdf_driver_for_a_bus_master_dma_device"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.handling_i_o_requests_in_a_kmdf_driver_for_a_bus_master_dma_device"></a>Handling I/O Requests in a KMDF Driver for a Bus-Master DMA Device</h1>
</div>
<p class="CCE_Message">[Applies to KMDF only]</p>
<p>This topics in this section describe how a KMDF driver for a bus-master DMA device processes an I/O request.  If you are writing a KMDF driver that implements system-mode DMA, see  <a href="supporting_system-mode_dma.htm">Supporting System-Mode DMA</a>.</p>
<h2><a id="ddk_how_to_program_an_i_o_request_for_a_dma_device_df"></a><a id="DDK_HOW_TO_PROGRAM_AN_I_O_REQUEST_FOR_A_DMA_DEVICE_DF"></a></h2>
<p>Handling I/O requests  in a KMDF driver for a bus-master DMA device requires code in several of the driver’s event callback functions, as shown in the following figure:</p><img src="images/dma_implementation_in_kmdf.png" alt="DMA Implementation in KMDF drivers"/><p>As shown above, DMA-related processing takes place in four phases:</p>
<ol>
<li>
<p>Your driver's <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a> or <a href="wdf.evtdevicepreparehardware"><i>EvtDevicePrepareHardware</i></a> callback function must <a href="enabling_dma_transactions.htm">enable DMA transactions</a> for the device, so that your driver can use the framework's DMA capabilities. The same callback function must also <a href="using_common_buffers.htm">create a common buffer</a> if your device and driver require access to a shared memory buffer.</p>
</li>
<li>
<p>When your driver receives an I/O request that requires the device to perform a DMA operation, one of the driver's <a href="request_handlers.htm">request handlers</a> must <a href="creating_and_initializing_a_dma_transaction.htm">create and initialize a new DMA transaction</a>. (Note that if your driver <a href="reusing_dma_transaction_objects.htm">reuses DMA transaction objects</a>, your driver's <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a> callback function can create the transaction objects.) Then, the request handler must <a href="starting_a_dma_transaction.htm">initiate the DMA transaction</a> so that the framework can begin breaking the transaction into smaller DMA transfers, if necessary, and call the driver's <a href="wdf.evtprogramdma"><i>EvtProgramDma</i></a> callback function. </p>
</li>
<li>
<p>Your driver's     <a href="wdf.evtprogramdma"><i>EvtProgramDma</i></a> callback function <a href="programming_dma_hardware.htm">programs the DMA hardware</a> for a single DMA transfer and enables device interrupts.</p>
</li>
<li>
<p>When the device interrupts, the framework calls your driver's <a href="wdf.evtinterruptisr"><i>EvtInterruptIsr</i></a> callback function, which saves volatile device information and schedules execution of the driver's      <a href="wdf.evtinterruptdpc"><i>EvtInterruptDpc</i></a> callback function.</p>
<p>Your driver's <a href="wdf.evtinterruptdpc"><i>EvtInterruptDpc</i></a> callback function <a href="completing_a_dma_transfer.htm">completes each DMA transfer</a> after the hardware finishes processing it. After a DMA transaction's final transfer is complete, the <i>EvtInterruptDpc</i> callback function <a href="completing_a_dma_transaction.htm">completes the DMA transaction</a>. </p>
</li>
</ol>
<p>Your driver might <a href="reusing_dma_transaction_objects.htm">reuse its DMA transaction objects</a> to ensure that they can operate when memory resources are low.</p>
<p>Your driver can provide a set of callback functions that handle <a href="supporting_power_management_for_dma_devices.htm">DMA-specific power management operations</a>. </p>
<p>Some drivers <a href="using_common_buffers.htm">use common buffers</a> that both a device and the driver can access.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Handling I/O Requests in a KMDF Driver for a Bus-Master DMA Device%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
