<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Some devices can enter a low-power (Dx) state while the system remains in its working (S0) state."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Supporting Idle Power-Down</title>

<meta name="MS-HAID" content="Ch4_DFPnPPackage_d6704fc2-1b71-437a-922b-216e1808beb4.xml"/>
<meta name="MS-HAID" content="kmdf.supporting_idle_power_down"/>
<meta name="MS-HAID" content="wdf.supporting_idle_power_down"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.supporting_idle_power_down"></a>Supporting Idle Power-Down</h1>
</div>
<p>
<p>Some devices can enter a low-power (Dx) state while the system remains in its working (S0) state.  Starting in Windows 8, devices can transition to a low-power functional power state (Fx) prior to entering a Dx state. For such devices, the framework initiates lowering power of the device or component after the device has been idle (not used) for a predetermined (and settable) amount of time.</p>
</p>
<p>Some of these devices can also trigger a wake-up signal on the bus when they detect an external event. The bus driver responds to this signal, and the driver stack restores the device to its working state. (Devices that do not detect external events remain in a low-power state until the framework asks the bus driver to initiate restoring the device to its working state.) </p>
<p>If your device or component can be powered down when it is idle, the <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a> callback function in the <a href="power_policy_ownership.htm">power policy owner</a> must perform the following two steps:</p>
<ol>
<li>
<p>Call <a href="wdf.wdfdeviceassigns0idlesettings"><b>WdfDeviceAssignS0IdleSettings</b></a> to specify:<ul>
<li>The low-power state that the device will enter </li>
<li>The amount of time that the device <a href="#idle_conditions">must remain idle</a> before its power state is lowered</li>
<li>Whether the device can detect an external event and trigger a wake-up signal on the bus</li>
<li>Whether users can control the device's idle settings</li>
<li>Whether the device's idle power-down capability is enabled or disabled</li>
<li>Whether the device will return to its working (D0) state when the system returns to its working (S0) state</li>
<li>Whether the idle timeout value for the device is determined by the power management framework (PoFx)</li>
<li>Whether the framework can put the device in the D3cold power state when the idle timeout period expires</li>
</ul>
</p>
<p>For more information about these settings, see the <a href="wdf.wdf_device_power_policy_idle_settings"><b>WDF_DEVICE_POWER_POLICY_IDLE_SETTINGS</b></a> structure, as well as <a href="supporting_functional_power_states.htm">Supporting Functional Power States</a>.</p>
</li>
<li>Call <a href="wdf.wdfdeviceinitsetpowerpolicyeventcallbacks"><b>WdfDeviceInitSetPowerPolicyEventCallbacks</b></a> to register the following event callback functions, if you need them for your device:<ul>
<li><a href="wdf.evtdevicearmwakefroms0"><i>EvtDeviceArmWakeFromS0</i></a>, which enables the device hardware (not the bus) to respond to an external wake-up event</li>
<li><a href="wdf.evtdevicedisarmwakefroms0"><i>EvtDeviceDisarmWakeFromS0</i></a>, which disables the device's ability (not the bus's ability) to respond to an external wake-up event</li>
<li><a href="wdf.evtdevicewakefroms0triggered"><i>EvtDeviceWakeFromS0Triggered</i></a>, which informs the driver that the bus detected a wake signal.</li>
</ul>
</li>
</ol>
<h2><a id="idle_conditions"></a><a id="IDLE_CONDITIONS"></a></h2>
<p>The framework considers the device to be idle, and starts counting idle time, when all of the following conditions are met:</p>
<ul>
<li>None of the power-managed queues created for this device instance have any requests waiting in queue or dispatched to the driver. If a request was dispatched to the driver and the driver sent it to an I/O target, the request is still related to the queue.    The device will not be considered idle, unless the driver used the <a href="wdf.wdf_request_forward_options_flags"><b>send and forget option</b></a> to send the request.  Requests in non-power managed queues are not counted toward device idle.</li>
<li>If the driver previously called <a href="wdf.wdfdevicestopidle"><b>WdfDeviceStopIdle</b></a>, the driver  has subsequently called <a href="wdf.wdfdeviceresumeidle"><b>WdfDeviceResumeIdle</b></a>.</li>
<li>If the power policy owner is a bus driver, none of the child devices of the bus driver are in D0.</li>
</ul>
<p>If your driver (or a user) enables idle power-down for your device, you might have to use the <a href="wdf.wdfdevicestopidle"><b>WdfDeviceStopIdle</b></a> method. If the device is in its working (D0) state, this method prevents the device from idling until the driver calls <a href="wdf.wdfdeviceresumeidle"><b>WdfDeviceResumeIdle</b></a>. If the device is in a low-power state when the driver calls <b>WdfDeviceStopIdle</b>, and if the system is in its working (S0) state, the framework requests the bus driver to restore the device to its working (D0) state. Every successful call to <b>WdfDeviceStopIdle</b> must be matched by a call to <b>WdfDeviceResumeIdle</b>.  For information about viewing the power reference count in the debugger, see <a href="debugging_power_reference_leaks_in_wdf.htm">Debugging Power Reference Leaks in WDF</a>.</p>
<p>For more information about when your driver might have to call <a href="wdf.wdfdevicestopidle"><b>WdfDeviceStopIdle</b></a>, see the method's reference page.</p>
<p>If the device can wake itself from a low-power state, the driver for the device's bus participates in waking the device. The bus driver typically provides <a href="wdf.evtdeviceenablewakeatbus"><i>EvtDeviceEnableWakeAtBus</i></a> and <a href="wdf.evtdevicedisablewakeatbus"><i>EvtDeviceDisableWakeAtBus</i></a> callback functions. These functions do whatever is necessary on the bus adapter to enable and disable a device's ability to wake from a low-power state.</p>
<p>For information about registry entries that control a device's idle capabilities, see <a href="user_control_of_device_idle_and_wake_behavior.htm">User Control of Device Idle and Wake Behavior</a>. </p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Supporting Idle Power-Down%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
