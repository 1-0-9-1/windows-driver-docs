<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="This topic describes how a User-Mode Driver Framework (UMDF) driver accesses protected resources, starting in UMDF version 2."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Handling Client Impersonation in UMDF Drivers</title>

<meta name="MS-HAID" content="wdf.handling_client_impersonation_in_umdf_drivers"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.handling_client_impersonation_in_umdf_drivers"></a>Handling Client Impersonation in UMDF Drivers</h1>
</div>
<p>This topic describes how a User-Mode Driver Framework (UMDF) driver accesses protected resources, starting in UMDF version 2.</p>
<p>UMDF drivers typically run under the LocalService account and cannot access files or resources that require user credentials, such as protected files or other protected resources. A UMDF driver typically operates on commands and data that flow between a client application and a device. Therefore, most UMDF drivers do not access protected resources.</p>
<p>However, some drivers might require access to a protected resource. For example, a UMDF driver might load firmware into a device from a file that a client application provides. The file might have an access control list (ACL) that prevents unauthorized users from modifying the file and taking control of the device. Unfortunately, this ACL also prevents the UMDF driver from accessing the file. </p>
<p>The framework provides an impersonation capability that allows drivers to impersonate the driver's client and obtain the client's access rights to protected resources. </p>
<h3><a id="enabling_impersonation"></a><a id="ENABLING_IMPERSONATION"></a>Enabling Impersonation</h3>
<p>Both the UMDF driver's installation package and the client application must enable the framework's impersonation capability, as follows:</p>
<ul>
<li>
<p>The INF file of the UMDF driver's installation package must include the <b>UmdfImpersonationLevel</b> directive and set the maximum allowable impersonation level. Impersonation is enabled only if the INF file includes the <b>UmdfImpersonationLevel</b> directive. For more information about setting the impersonation level, see <a href="specifying_wdf_directives_in_inf_files.htm">Specifying WDF Directives in INF Files</a>. </p>
</li>
<li>
<p>The client application must set the allowed impersonation level for each file handle. The application uses the quality of service (QoS) settings in the Microsoft Win32 <b>CreateFile</b> function to set the allowed impersonation level. For more information about these settings, see the <i>dwFlagsAndAttributes</i> parameter of <b>CreateFile</b> in the Windows SDK documentation. </p>
</li>
</ul>
<h3><a id="handling_impersonation_for_an_i_o_request"></a><a id="HANDLING_IMPERSONATION_FOR_AN_I_O_REQUEST"></a>Handling Impersonation for an I/O Request</h3>
<p>The UMDF driver and framework handle impersonation for an I/O request in the following sequence:</p>
<ol>
<li>
<p>The driver calls the <a href="wdf.wdfrequestimpersonate"><b>WdfRequestImpersonate</b></a> method to specify the required impersonation level and an <a href="wdf.evtrequestimpersonate"><i>EvtRequestImpersonate</i></a> callback function. </p>
</li>
<li>
<p>The framework checks the requested impersonation level. If the requested level is greater than the level that the UMDF driver's installation package and the client application allow, the impersonation request fails. Otherwise, the framework impersonates the client and immediately calls the <a href="wdf.evtrequestimpersonate"><i>EvtRequestImpersonate</i></a> callback function.</p>
</li>
</ol>
<p>The <a href="wdf.evtrequestimpersonate"><i>EvtRequestImpersonate</i></a> callback function must perform only the operations that require the requested impersonation level, such as opening a protected file. </p>
<p>The framework does not allow a driver's <a href="wdf.evtrequestimpersonate"><i>EvtRequestImpersonate</i></a> callback function to call any of the framework's object methods. This ensures that the driver does not expose the impersonation level to other driver callback functions or other drivers.</p>
<p>As a best practice, your driver should not <a href="canceling_i_o_requests.htm">enable cancellation</a> of an I/O request before calling <a href="wdf.wdfrequestimpersonate"><b>WdfRequestImpersonate</b></a> for that request.</p>
<p>The <a href="wdf.wdfrequestimpersonate"><b>WdfRequestImpersonate</b></a> method grants only the impersonation level that the driver requests.</p>
<h3><a id="passing_credentials_down_the_driver_stack"></a><a id="PASSING_CREDENTIALS_DOWN_THE_DRIVER_STACK"></a>Passing Credentials down the Driver Stack</h3>
<p>When your driver receives a <a href="wdf.wdf_request_type"><b>WdfRequestTypeCreate</b></a>-typed I/O request, the driver might forward the I/O request down the driver stack to a kernel-mode driver. Kernel-mode drivers do not have the impersonation capability that <a href="wdf.wdfrequestimpersonate"><b>WdfRequestImpersonate</b></a> provides to UMDF drivers.</p>
<p>Therefore, if you want a kernel-mode driver to receive the client's user credentials (rather the credentials of the <a href="umdf_driver_host_process.htm">driver host process</a>), the driver must set the <a href="wdf.wdf_request_send_options_flags"><b>WDF_REQUEST_SEND_OPTION_IMPERSONATE_CLIENT</b></a> flag when it calls <a href="wdf.wdfrequestsend"><b>WdfRequestSend</b></a> to send the create request to the I/O target. The <b>Send</b> method returns an error code if the impersonation attempt fails, unless the driver also sets the <b>WDF_REQUEST_SEND_OPTION_IMPERSONATION_IGNORE_FAILURE</b> flag.</p>
<p>The following example shows how a UMDF driver might use the <b>WDF_REQUEST_SEND_OPTION_IMPERSONATE_CLIENT</b> flag to send a file creation request to an I/O target. The driver's INF file must also include the <b>UmdfImpersonationLevel</b> directive as described above.</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>WDFIOTARGET iotarget;
WDF_REQUEST_SEND_OPTIONS options;
NTSTATUS status;
WDF_REQUEST_PARAMETERS params;
ULONG sendFlags;  
 
WDF_REQUEST_PARAMETERS_INIT(&amp;params);
WdfRequestGetParameters(Request, &amp;params);
   
sendFlags = WDF_REQUEST_SEND_OPTION_SYNCHRONOUS;
if (params.Type == WdfRequestTypeCreate) {
    sendFlags |= WDF_REQUEST_SEND_OPTION_IMPERSONATE_CLIENT;
}
   
WDF_REQUEST_SEND_OPTIONS_INIT(&amp;options, sendFlags);
if (WdfRequestSend(Request,
                   iotarget,
                   &amp;options
                   ) == FALSE) {
    status = WdfRequestGetStatus(Request);
}
</pre>
</td>
</tr>
</table></span></div>
<p>The driver does not have to call <a href="wdf.wdfrequestimpersonate"><b>WdfRequestImpersonate</b></a> before it sends the request to the I/O target. </p>
<p>If lower-level drivers also forward the request, the client's impersonation level travels down the driver stack.</p>
<h3><a id="reducing_security_threats"></a><a id="REDUCING_SECURITY_THREATS"></a>Reducing Security Threats</h3>
<p>To reduce the chance of an "elevation of privilege" attack, you should:  </p>
<ul>
<li>
<p>Try to avoid using impersonation. </p>
<p>For example, to avoid using impersonation to open a file that the driver must use, the client application can open the file and use I/O operations to send file contents to the driver.</p>
</li>
<li>
<p>Use the lowest impersonation level that your driver requires. </p>
<p>Set the impersonation level in your driver's INF file as low as possible. If your driver does not require any impersonation, do not include the <b>UmdfImpersonationLevel</b> directive in the INF file.</p>
</li>
<li>
<p>Minimize the opportunities for an attacker to exploit your driver. </p>
<p>Your <a href="wdf.evtrequestimpersonate"><i>EvtRequestImpersonate</i></a> callback function should contain a small section of code that performs only the operation that requires impersonation. For example, if your driver accesses a protected file, it requires impersonation only when it opens the file handle. It does not require impersonation to read from or write to the file.</p>
</li>
</ul>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Handling Client Impersonation in UMDF Drivers%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
