<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Supporting WMI Data Blocks and Events in Your Driver"/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Supporting WMI Data Blocks and Events in Your Driver</title>

<meta name="MS-HAID" content="Ch7_DFWMIPackage_1df4918e-0d56-4113-9c13-e8264ebcdf4b.xml"/>
<meta name="MS-HAID" content="kmdf.supporting_wmi_data_blocks_and_events_in_your_driver"/>
<meta name="MS-HAID" content="wdf.supporting_wmi_data_blocks_and_events_in_your_driver"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.supporting_wmi_data_blocks_and_events_in_your_driver"></a>Supporting WMI Data Blocks and Events in Your Driver</h1>
</div>
<p class="CCE_Message">[Applies to KMDF only]</p>
<p>Framework-based drivers support WMI data blocks by providing event callback functions. Drivers support WMI events by calling an object method that sends an event to WMI clients. </p>
<h3><a id="supporting_read_write_wmi_data_blocks"></a><a id="SUPPORTING_READ_WRITE_WMI_DATA_BLOCKS"></a>
      Supporting Read/Write WMI Data Blocks</h3>
<p>If the information in a WMI data block is both readable and writeable by WMI clients, the driver must provide an <a href="wdf.evtwmiinstancequeryinstance"><i>EvtWmiInstanceQueryInstance</i></a> callback function that services a client's read requests, plus <a href="wdf.evtwmiinstancesetinstance"><i>EvtWmiInstanceSetInstance</i></a> or <a href="wdf.evtwmiinstancesetitem"><i>EvtWmiInstanceSetItem</i></a> callback functions (or both) that service a client's write requests. </p>
<p>If the data block contains methods that the driver executes at the client's request, the driver must also provide an <a href="wdf.evtwmiinstanceexecutemethod"><i>EvtWmiInstanceExecuteMethod</i></a> callback function. </p>
<p>If a WMI data block is write-only (that is, WMI clients can write information to the data block but cannot read the data block), the driver does not provide an <a href="wdf.evtwmiinstancequeryinstance"><i>EvtWmiInstanceQueryInstance</i></a> callback function.</p>
<h3><a id="supporting_read_only_wmi_data_blocks"></a><a id="SUPPORTING_READ_ONLY_WMI_DATA_BLOCKS"></a>
      Supporting Read-Only WMI Data Blocks</h3>
<p>If the information in a WMI data block cannot be modified by a WMI client, the driver does not provide <a href="wdf.evtwmiinstancesetinstance"><i>EvtWmiInstanceSetInstance</i></a> or <a href="wdf.evtwmiinstancesetitem"><i>EvtWmiInstanceSetItem</i></a> callback functions. To support requests for the data block's information from WMI clients, the driver can do either of the following:</p>
<ul>
<li>
<p>Provide an <a href="wdf.evtwmiinstancequeryinstance"><i>EvtWmiInstanceQueryInstance</i></a> callback function to copy driver-supplied data into a WMI-supplied buffer.</p>
</li>
<li>
<p>Store the data block's information in the WMI instance object's <a href="framework_object_context_space.htm">context space</a>, and set the <b>UseContextForQuery</b> member of the instance's <a href="wdf.wdf_wmi_instance_config"><b>WDF_WMI_INSTANCE_CONFIG</b></a> structure to <b>TRUE</b>.</p>
</li>
</ul>
<p>If the driver sets <b>UseContextForQuery</b> to <b>TRUE</b>, the framework copies the instance object's context space into a WMI-supplied buffer when a WMI client requests the instance's information. No <i>EvtWmiInstanceXxx</i> callbacks are required if the driver has only a single WMI instance that provides read-only, fixed-length data from its object context area.</p>
<p>If a read-only data block contains methods that the driver executes at the client's request, the driver can also provide an <a href="wdf.evtwmiinstanceexecutemethod"><i>EvtWmiInstanceExecuteMethod</i></a> callback function.</p>
<h3><a id="supporting_expensive_wmi_data_blocks"></a><a id="SUPPORTING_EXPENSIVE_WMI_DATA_BLOCKS"></a>Supporting Expensive WMI Data Blocks</h3>
<p>If your driver collects relatively large amounts of dynamic data to support one of its WMI data blocks, the driver should do the following:</p>
<ul>
<li>
<p>Declare the data block to be "expensive" by setting the <b>WdfWmiProviderExpensive</b> flag in the <b>Flags</b> member of the WMI provider object's <a href="wdf.wdf_wmi_provider_config"><b>WDF_WMI_PROVIDER_CONFIG</b></a> structure.</p>
</li>
<li>
<p>Provide an <a href="wdf.evtwmiproviderfunctioncontrol"><i>EvtWmiProviderFunctionControl</i></a> callback function that enables and disables data collection for the data block, or call <a href="wdf.wdfwmiproviderisenabled"><b>WdfWmiProviderIsEnabled</b></a> to determine whether the driver should enable or disable data collection.</p>
</li>
</ul>
<p>If your driver sets the <b>WdfWmiProviderExpensive</b> flag, the framework calls the <a href="wdf.evtwmiproviderfunctioncontrol"><i>EvtWmiProviderFunctionControl</i></a> callback function when a WMI client registers to access the data block. The callback function should enable the driver's ability to collect data. If all WMI clients remove their registrations for the data block, the framework calls the <i>EvtWmiProviderFunctionControl</i> callback function again so the driver can stop collecting data.</p>
<h3><a id="supporting_wmi_events"></a><a id="SUPPORTING_WMI_EVENTS"></a>Supporting WMI Events</h3>
<p>A driver can use WMI events to notify WMI clients of exceptional conditions. (You should not use WMI events as an alternative to logging errors.) Like data items, WMI events are defined in WMI data blocks within managed object format (.mof) files. </p>
<p>WMI clients register for notification of WMI events. To send an event to registered WMI clients, your driver calls the <a href="wdf.wdfwmiinstancefireevent"><b>WdfWmiInstanceFireEvent</b></a> method. This method allows the driver to optionally send event-specific data to the clients.</p>
<p>If the WMI data block that defines the event also contains WMI data items or method items, the driver provides appropriate WMI callback functions. If a data block defines an event but contains no data or method items, your driver must set the <b>WdfWmiProviderEventOnly</b> flag in the <b>Flags</b> member of the WMI provider object's <a href="wdf.wdf_wmi_provider_config"><b>WDF_WMI_PROVIDER_CONFIG</b></a> structure.</p>
<p>The driver should call <a href="wdf.wdfwmiinstancefireevent"><b>WdfWmiInstanceFireEvent</b></a> only if a WMI client has registered for event notification. The driver can determine if it should call <b>WdfWmiInstanceFireEvent</b> by either providing an <a href="wdf.evtwmiproviderfunctioncontrol"><i>EvtWmiProviderFunctionControl</i></a> callback function or calling <a href="wdf.wdfwmiproviderisenabled"><b>WdfWmiProviderIsEnabled</b></a>.</p>
<h3><a id="supporting_wmi_event_tracing"></a><a id="SUPPORTING_WMI_EVENT_TRACING"></a>Supporting WMI Event Tracing</h3>
<p>Trace events are defined in .mof files, in the same manner as other WMI events. When your driver creates a WMI provider object for a trace event, it must set the <b>WdfWmiProviderTracing</b> flag in the <b>Flags</b> member of the provider object's <a href="wdf.wdf_wmi_provider_config"><b>WDF_WMI_PROVIDER_CONFIG</b></a> structure. </p>
<p>After a provider instance has been registered, the driver can call <a href="wdf.wdfwmiprovidergettracinghandle"><b>WdfWmiProviderGetTracingHandle</b></a> to obtain a tracing handle. The driver can use the tracing handle as input to the <a href="kernel.wmitracemessage"><b>WmiTraceMessage</b></a> routine.</p>
<p>For more information about event tracing, see:</p>
<dl>
<dd>
<p><a href="kernel.wmi_event_tracing">WMI Event Tracing</a></p>
</dd>
<dd>
<p><a href="devtest.wpp_software_tracing">WPP Software Tracing</a></p>
</dd>
</dl>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Supporting WMI Data Blocks and Events in Your Driver%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
