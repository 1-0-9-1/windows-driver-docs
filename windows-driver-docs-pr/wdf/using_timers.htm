<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="This topic describes how to use the framework's built-in timer support. It applies to both Kernel-Mode Driver Framework (KMDF) drivers as well as User-Mode Driver Framework (UMDF) drivers starting in version 2."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Using Timers</title>

<meta name="MS-HAID" content="Ch8_DFTechniques_8b978dd3-67bb-494b-b756-4ffe81ec916c.xml"/>
<meta name="MS-HAID" content="kmdf.using_timers"/>
<meta name="MS-HAID" content="wdf.using_timers"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.using_timers"></a>Using Timers</h1>
</div>
<p>This topic describes how to use the framework's built-in timer support. It applies to both Kernel-Mode Driver Framework (KMDF) drivers as well as User-Mode Driver Framework (UMDF) drivers starting in version 2.</p>
<p>The framework provides a <i>timer object</i> that enables drivers to create timers. After a driver creates a timer object and starts the timer's clock, the framework calls a driver-supplied callback function after a specified amount of time has elapsed. Optionally, your driver can set up the timer so that the framework calls the callback function repeatedly, whenever a specified amount of time has elapsed.</p>
<p>To create a framework timer object, your driver must call the <a href="wdf.wdftimercreate"><b>WdfTimerCreate</b></a> method. This method registers an <a href="wdf.evttimerfunc"><i>EvtTimerFunc</i></a> callback function and a periodic time interval. If you want the framework to call the callback function only once, your driver specifies zero for the periodic time interval.</p>
<p>Typically, you will know the number of timers that your driver will need for each device. Therefore, the driver can create timer objects by calling <a href="wdf.wdftimercreate"><b>WdfTimerCreate</b></a> in its <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a> callback function, and it can store timer object handles in a device or queue object's <a href="framework_object_context_space.htm">context space</a>.  </p>
<p>To start the timer, your driver calls <a href="wdf.wdftimerstart"><b>WdfTimerStart</b></a>, passing a "due time". The framework starts the timer's clock and calls the <a href="wdf.evttimerfunc"><i>EvtTimerFunc</i></a> callback function when the specified amount of time has elapsed. </p>
<p>If the driver supplied a periodic time interval when it called <a href="wdf.wdftimercreate"><b>WdfTimerCreate</b></a>, the timer is referred to as a <i>periodic timer</i>. A periodic timer's clock continues to run after the initial "due time" has elapsed, and the framework calls the driver's callback function repeatedly, whenever the periodic time interval has elapsed. </p>
<p>A driver might call <a href="wdf.wdftimerstart"><b>WdfTimerStart</b></a> from its <a href="wdf.evttimerfunc"><i>EvtTimerFunc</i></a> callback function in order to restart a non-periodic timer after it expires.</p>
<p>To stop a timer, the driver can call <a href="wdf.wdftimerstop"><b>WdfTimerStop</b></a>. Your driver can reuse timers by starting and stopping them repeatedly.</p>
<p>When your driver creates a timer object, it must specify a parent object. The framework stops the timer and deletes the timer object when the parent is deleted. To obtain a timer object's parent object, your driver can call <a href="wdf.wdftimergetparentobject"><b>WdfTimerGetParentObject</b></a>.</p>
<p>In KMDF versions prior to version 1.9, you cannot easily use timer objects if you want all of your driver's callback functions to run at IRQL = PASSIVE_LEVEL. The framework implements the timer object's <a href="wdf.evttimerfunc"><i>EvtTimerFunc</i></a> callback function as a deferred procedure call (DPC) that is called at IRQL = DISPATCH_LEVEL. Therefore, if you want your timer expiration code to run at PASSIVE_LEVEL the <i>EvtTimerFunc</i> callback function must queue a <a href="using_framework_work_items.htm">work item</a> that runs at PASSIVE_LEVEL.</p>
<p>In KMDF versions 1.9 and later, you can create <i>passive-level timers</i>, which are timers that run at PASSIVE_LEVEL. To create a passive-level timer, specify the <a href="wdf.wdf_execution_level"><b>WdfExecutionLevelPassive</b></a> execution level when your driver calls <a href="wdf.wdftimercreate"><b>WdfTimerCreate</b></a>. As a result, the framework implements <a href="wdf.evttimerfunc"><i>EvtTimerFunc</i></a> callback functions as work items that run at PASSIVE_LEVEL. Note that passive-level timers cannot be periodic timers.</p>
<p>Starting in UMDF version 2.0, the framework implements the timer object's <a href="wdf.evttimerfunc"><i>EvtTimerFunc</i></a> callback functions as worker threads from the user-mode thread pool. As a result, a UMDF driver's timer callback functions always run at PASSIVE_LEVEL.</p>
<h2><a id="No_Wake_Timers"></a><a id="no_wake_timers"></a><a id="NO_WAKE_TIMERS"></a>No Wake Timers</h2>
<p>System power efficiency is reduced by timers that repeatedly cause the system to resume from low-power states.    

One way to improve battery life is to delay non-critical periodic operations rather than waking the system. Starting in  Windows 8.1, you can use <i>no wake timers</i> to perform such non-critical operations in either a KMDF or UMDF driver.

 A no wake timer does not wake the system if it expires while the system is in a low-power state. Instead, the framework calls the driver's <a href="wdf.evttimerfunc"><i>EvtTimerFunc</i></a> callback function the next time the system is in its fully on, S0 state.</p>
<p> No wake timers are available starting with KMDF version 1.13 and UMDF version 2.0. </p>
<p>To create a no wake timer, set the <b>TolerableDelay</b> member of <a href="wdf.wdf_timer_config"><b>WDF_TIMER_CONFIG</b></a>  to <b>TolerableDelayUnlimited</b>.</p>
<p>For more information about no wake timers, see <a href="kernel.no_wake_timers">No-Wake Timers</a>.</p>
<h2><a id="High_Resolution_Timers"></a><a id="high_resolution_timers"></a><a id="HIGH_RESOLUTION_TIMERS"></a>High Resolution Timers</h2>
<p>Standard framework timers have an accuracy that matches  the system clock tick interval, which is by default 15.6 milliseconds.
             Starting in Windows 8.1, you can create <i>high resolution timers</i>. A high resolution timer has  an accuracy of one millisecond. You might use a high resolution timer for a critical operation that requires a precise, predictable expiration time. As a result of the frequent servicing that it requires, a high resolution timer may result in decreased battery life.</p>
<p>High resolution timers are available only to KMDF drivers, starting with KMDF version 1.13.</p>
<p>To create a high resolution timer, set the <b>UseHighResolutionTimer</b> member of <a href="wdf.wdf_timer_config"><b>WDF_TIMER_CONFIG</b></a> to <b>WdfTrue</b>, and then adjust the <b>Period</b> value to the desired resolution.</p>
<p>The following table shows examples of timer behavior based on different values that the driver provides for <b>Period</b>. These examples assume that the system clock tick interval is 15 milliseconds.</p>
<table>
<tr>
<th>Period, in ms</th>
<th>Standard Timer</th>
<th>High Resolution Timer</th>
</tr>
<tr>
<td>
<p>10</p>
</td>
<td>
<p>The timer expires between 0 milliseconds and 25 milliseconds.</p>
</td>
<td>
<p>The timer expires as soon after 10 milliseconds as possible.</p>
</td>
</tr>
<tr>
<td>
<p>16</p>
</td>
<td>
<p>The timer expires between 15 milliseconds and 30 milliseconds.</p>
</td>
<td>
<p>The timer expires as soon after 16 milliseconds as possible.</p>
</td>
</tr>
</table>
<p> </p>
<p>For more information about high resolution timers, see <a href="kernel.high_resolution_timers">High-Resolution Timers</a>.</p>
<p>For more information about how timer accuracy is related to the granularity of the system clock, see <a href="kernel.timer_accuracy">Timer Accuracy</a>.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Using Timers%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
