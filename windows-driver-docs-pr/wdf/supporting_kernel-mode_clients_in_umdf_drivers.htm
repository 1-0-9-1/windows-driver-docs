<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="This topic describes how a User-Mode Driver Framework (UMDF) driver supports kernel-mode clients, starting in UMDF version 2."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Supporting Kernel-Mode Clients in UMDF Drivers</title>

<meta name="MS-HAID" content="wdf.supporting_kernel-mode_clients_in_umdf_drivers"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.supporting_kernel-mode_clients_in_umdf_drivers"></a>Supporting Kernel-Mode Clients in UMDF Drivers</h1>
</div>
<p>This topic describes how a User-Mode Driver Framework (UMDF) driver supports <i>kernel-mode clients</i>, starting in UMDF version 2.</p>
<p>A <i>kernel-mode client</i> is a kernel-mode driver that sends I/O requests to your UMDF driver. The kernel-mode driver might be above the UMDF driver, in the same device stack, or it might be in a different device stack.</p>
<p>The kernel-mode driver can forward I/O requests that it has received from a user-mode application, or can create new I/O requests and send them to the user-mode driver.</p>
<h3><a id="how_to_support_kernel_mode_clients_in_a_umdf_based_driver"></a><a id="HOW_TO_SUPPORT_KERNEL_MODE_CLIENTS_IN_A_UMDF_BASED_DRIVER"></a>How to support kernel-mode clients in a UMDF driver</h3>
<p>To enable a UMDF driver's support for kernel-mode clients, the INF file of the UMDF driver must include a <a href="specifying_wdf_directives_in_inf_files.htm">UmdfKernelModeClientPolicy</a> directive in its INF <i>DDInstall</i>.<b>WDF</b> section.</p>
<p>The framework provides two methods that are useful to drivers that support kernel-mode clients. A driver can call the <a href="wdf.wdfrequestgetrequestormode"><b>WdfRequestGetRequestorMode</b></a> method to determine whether an I/O request came from kernel mode or user mode. If the I/O request came from user mode, the driver can call <a href="wdf.wdfrequestisfromusermodedriver"><b>WdfRequestIsFromUserModeDriver</b></a> to determine whether the request came from an application or another user-mode driver.</p>
<h3><a id="restrictions_on_kernel_mode_drivers"></a><a id="RESTRICTIONS_ON_KERNEL_MODE_DRIVERS"></a>Restrictions on kernel-mode drivers</h3>
<p>A UMDF driver can process I/O requests from a kernel-mode driver only if the kernel-mode driver meets the following requirements:</p>
<ul>
<li>
<p>The kernel-mode driver must be running at IRQL = PASSIVE_LEVEL when it sends the I/O request.</p>
</li>
<li>
<p>Unless the driver has set the <b>UmdfFileObjectPolicy</b> INF directive to <b>AllowNullAndUnknownFileObjects</b>, each I/O request that a kernel-mode driver sends to a user-mode driver must have an associated file object. The framework must have previously been notified that the I/O manager created the file object. (Such notification causes the framework to call the user-mode driver's <a href="wdf.evtdevicefilecreate"><i>EvtDeviceFileCreate</i></a>  callback function, but that callback function is optional.) </p>
</li>
<li>
<p>The I/O request cannot contain an <a href="kernel.irp_mj_internal_device_control"><b>IRP_MJ_INTERNAL_DEVICE_CONTROL</b></a> function code. </p>
</li>
<li>
<p>The I/O request's buffers must not contain pointers to additional information, because the user-mode driver cannot dereference the pointers.</p>
</li>
<li>
<p>If the I/O request contains an <a href="kernel.using_i_o_control_codes">I/O control code</a> that specifies the "neither" buffer access method, the kernel-mode driver must send the I/O request in the process context of the application that created the I/O request. For more information about how to support the "neither" method in a UMDF driver, see <a href="managing_buffer_access_methods_in_umdf_drivers.htm">Managing Buffer Access Methods in UMDF Drivers</a>.</p>
</li>
<li>
<p>The UMDF driver might modify an I/O request's output data, in user mode. Therefore, the kernel-mode driver must validate any output data that it receives from the user-mode driver.</p>
</li>
<li>
<p>The kernel-mode client should typically validate the <i>Information</i> value that a UMDF driver passes to <a href="wdf.wdfrequestcompletewithinformation"><b>WdfRequestCompleteWithInformation</b></a>.  If the client is a KMDF driver, it can call <a href="wdf.wdfrequestgetcompletionparams"><b>WdfRequestGetCompletionParams</b></a> to obtain this information in an IO_STATUS_BLOCK structure.</p>
<p>Typically, the framework does not validate the information value that a UMDF driver passes to <a href="wdf.wdfrequestcompletewithinformation"><b>WdfRequestCompleteWithInformation</b></a>. (This parameter usually specifies the number of transferred bytes.) The framework validates the information value only for output buffers, and only for the <a href="wdf.accessing_data_buffers_in_kmdf_drivers#direct#direct">buffered I/O</a> data access method. (For example, the framework verifies that the number of transferred bytes does not exceed the output buffer size of a read operation, if the access method is buffered I/O.) </p>
</li>
</ul>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Supporting Kernel-Mode Clients in UMDF Drivers%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
