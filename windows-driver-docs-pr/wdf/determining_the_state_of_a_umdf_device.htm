<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="This topic describes how you can use debugger extensions in conjunction with a User-Mode Driver Framework (UMDF) version 1 or 2 driver to determine what state your UMDF device is in."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Determining the State of a UMDF Device</title>

<meta name="MS-HAID" content="umdfobjectdg_c1948e15-50bb-4efb-a4b8-3ecceb2200ac.xml"/>
<meta name="MS-HAID" content="umdf.determining_the_state_of_a_umdf_device"/>
<meta name="MS-HAID" content="wdf.determining_the_state_of_a_umdf_device"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.determining_the_state_of_a_umdf_device"></a>Determining the State of a UMDF Device</h1>
</div>
<p>This topic describes how you can use debugger extensions in conjunction with a User-Mode Driver Framework (UMDF) version 1 or 2 driver to determine what state your UMDF device is in.</p>
<p>For UMDF version 1, you'll use extension commands implemented in wudfext.dll. Starting in UMDF version 2, you'll use extension commands implemented in wdfkd.dll.</p>
<p>To determine device state, use the following steps:</p>
<ol>
<li>Break into a driver host process by using one of the following debugger types:<ul>
<li>User-mode debugger:<ol>
<li>
<p>Locate the appropriate driver host process for the device (that is, WUDFHost.exe). If there are multiple instances of the host process, you can use the operating system-supplied Tasklist.exe application to determine which process is hosting your driver.</p>
<p> Use this command from an elevated Command Prompt.</p>
<p><b>tasklist -m &lt;yourdriver.dll&gt;</b></p>
</li>
<li>Start the debugger with elevated privilege and attach to the appropriate process.</li>
<li>Reload symbols by using the <b>.reload</b> debugger command. </li>
<li>You can view all the threads by using the <b>~*k</b> debugger command. </li>
</ol>
</li>
<li>Kernel-mode debugger:<ol>
<li>
<p>Locate the appropriate driver host process for the device (that is, WUDFHost.exe). Use the <b>!process</b> kernel-mode debugger extension as shown in the following example to obtain a list of all WUDFHost.exe instances:</p>
<p><b> !process 0 0 WUDFHost.exe</b></p>
<p>The process address and Process Environment Block (PEB) address from the <b>!process 0 0</b> output are used in the next steps.</p>
</li>
<li>Attach to the host process in one of the following ways:<ul>
<li>
<p>Use the <b>.process</b> debugger command for a non-invasive attach as shown in the following example:</p>
<p><b>.process /p /r &lt;process-addr&gt;</b></p>
<p>You should use non-invasive attach when you cannot let the execution continue. For example, you should use non-invasive attach when you receive a break in your application and you want to see what the driver did to cause that break or when the reflector prepares to terminate your host process.</p>
</li>
<li>
<p>Use the <b>.process</b> debugger command in an invasive attach as shown in the following example:</p>
<p><b>.process /i &lt;process-addr&gt;</b></p>
<p>The debugger will request that you continue by using the <b>g</b> debugger command; shortly after you execute the <b>g</b> debugger command, the debugger will break into the active process. Reload user symbols by using the <b>.reload</b> debugger command as shown in the followingexample:</p>
<p><b> .reload /user</b></p>
</li>
</ul>
</li>
<li>
<p>If there are multiple instances of host process, you can use the <b>!peb</b> general debugger extension as shown in the following example to obtain the list of modules that are loaded in the process:</p>
<p><b> !peb &lt;PEB-Address&gt;</b></p>
<p>You need to attach to the process for this command to work. You can attach non-invasively as shown in the previous step.</p>
<p>Locate the process in which your driver DLL is loaded.</p>
</li>
<li>
<p>Use the <b>!process</b> kernel-mode debugger extension as shown in the following example to obtain information about the process. The information includes the threads that run in the process and the addresses of those threads:</p>
<p><b>!process &lt;process-addr&gt;</b></p>
</li>
<li>
<p>Use the <b>!thread</b> kernel-mode debugger extension as shown in the following example to obtain information about each thread:</p>
<p><b>!thread &lt;thread-addr&gt;</b></p>
</li>
</ol>
</li>
</ul>
</li>
<li>In the debugger, use the <b>.chain</b> command to see if the wudfext.dll (UMDF 1) or wdfkd.dll (UMDF 2) debugger extension library is loaded.</li>
<li>If the library you need is not present, use the  <a href="debugger._load___loadby__load_extension_dll_"><b>.load</b></a> command to load the extension DLL into the debugger. Then enter <b>.reload</b> to reload symbol information.</li>
<li>
<p>Use <a href="debugger._wudfext_umdevstacks"><b>!wudfext.umdevstacks</b></a> (UMDF 1) or <a href="debugger._wdfkd_wdfumdevstacks"><b>!wdfkd.wdfumdevstacks</b></a> (UMDF 2) to see all device stacks loaded in the host process.</p>
<p>Then use <a href="debugger._wudfext_umdevstack"><b>!wudfext.umdevstack</b></a> (UMDF 1) or <a href="debugger._wdfkd_wdfumdevstack"><b>!wdfkd.wdfumdevstack</b></a> (UMDF 2) to get detailed information about the device stack.</p>
</li>
<li>
<p>Use <a href="debugger._wudfext_wudfdevice"><b>!wudfext.wudfdevice</b></a> (UMDF 1) or <a href="debugger._wdfkd_wdfdevice"><b>!wdfkd.wdfdevice</b></a>  (UMDF 2) to obtain information about the Plug and Play (PnP) and power-management state of the device.</p>
</li>
<li>Use <a href="debugger._wudfext_wudfdriverinfo"><b>!wudfext.wudfdriverinfo</b></a> (UMDF 1) or  <a href="debugger._wdfkd_wdfdriverinfo"><b>!wdfkd.wdfdriverinfo</b></a> (UMDF 2) to  display additional  information about the driver, including its device tree.</li>
</ol>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Determining the State of a UMDF Device%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
