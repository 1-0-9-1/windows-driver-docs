<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="If you are writing a UMDF driver, you can specify preferences for the buffer access method that the framework uses for read and write requests, as well as device I/O control requests."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Managing Buffer Access Methods in UMDF Drivers</title>

<meta name="MS-HAID" content="wdf.specifying_a_preferred_buffer_access_method_in_a_umdf_driver"/>
<meta name="MS-HAID" content="wdf.managing_buffer_access_methods_in_umdf_drivers"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.managing_buffer_access_methods_in_umdf_drivers"></a>Managing Buffer Access Methods in UMDF Drivers</h1>
</div>
<p>
<p>If you are writing a UMDF driver, you can  specify <i>preferences</i> for the <a href="wdf.accessing_data_buffers_in_kmdf_drivers">buffer access method</a> that the framework uses for read and write requests, as well as device I/O control requests. The values that a UMDF driver provides are only preferences, and are not guaranteed to be used by the framework.</p>
</p>
<p>
<ul>
<li><a href="#specifying_preferred_buffer_access_method">Specifying a Preferred Buffer Access Method</a></li>
<li><a href="#retrieving_access_method">Retrieving the Access Method for an I/O Request</a></li>
<li><a href="#using_neither_buffered_i_o_nor_direct_i_o_in_umdf_drivers">
      Converting from Neither Buffered I/O nor Direct I/O</a></li>
</ul>
</p>
<h2><a id="specifying_preferred_buffer_access_method"></a><a id="SPECIFYING_PREFERRED_BUFFER_ACCESS_METHOD"></a>Specifying a Preferred Buffer Access Method</h2>
<p>Starting in UMDF version 2.0, a UMDF driver calls <a href="wdf.wdfdeviceinitsetiotypeex"><b>WdfDeviceInitSetIoTypeEx</b></a> to register preferred access methods for read/write requests and for device I/O control requests.</p>
<p>If the driver does not call <a href="wdf.wdfdeviceinitsetiotypeex"><b>WdfDeviceInitSetIoTypeEx</b></a>, UMDF uses the buffered method for I/O requests to this device.</p>
<p>The framework uses the following rules to determine which access method to use:</p>
<ul>
<li>
<p>All UMDF drivers in a driver stack must use the same method for accessing a device's buffers, and the framework gives preference to buffered I/O.</p>
<p> If UMDF determines that some drivers prefer either buffered I/O or direct I/O for a device while other drivers prefer only buffered I/O for the device, UMDF uses buffered I/O for all drivers. If one or more of a stack's drivers prefer only buffered I/O while others prefer only direct I/O, UMDF logs an event to the system event log and does not start the driver stack.</p>
<p>Your driver can call <a href="wdf.wdfdevicegetdevicestackiotype"><b>WdfDeviceGetDeviceStackIoType</b></a> to determine the buffer access methods that UMDF has assigned to a device's read/write requests and I/O control requests.</p>
</li>
<li>
<p>In some cases, UMDF assigns  direct I/O to a device, but for best performance, uses buffered I/O for one or more of the device's requests. For example, UMDF uses buffered I/O for small buffers if it can copy the data to the driver's buffer faster than it can map the buffers for direct access.</p>
<p>Optionally, your driver can provide a <b>DirectTransferThreshold</b> value  when it calls <a href="wdf.wdfdeviceinitsetiotypeex"><b>WdfDeviceInitSetIoTypeEx</b></a>. The framework uses this value to determine the smallest buffer size for which the framework will use direct I/O.   Typically, you do not need to provide this value because the framework uses settings that provide the best performance.</p>
</li>
<li>
<p>UMDF uses direct I/O only for buffer space that begins and ends on a memory page boundary. If either the beginning or the end of a buffer does not lie on a page boundary, UMDF uses buffered I/O for that part of the buffer. In other words, UMDF might use both buffered I/O and direct I/O for a large data transfer that consists of several I/O requests.</p>
</li>
<li>
<p>For device I/O control requests, UMDF uses direct I/O only if the I/O control code (IOCTL) specifies direct I/O and only if all of the UMDF drivers for that device have called <a href="wdf.wdfdeviceinitsetiotypeex"><b>WdfDeviceInitSetIoTypeEx</b></a> to specify the direct access method.</p>
</li>
</ul>
<h2><a id="retrieving_access_method"></a><a id="RETRIEVING_ACCESS_METHOD"></a>Retrieving the Access Method for an I/O Request</h2>
<p>Drivers use the same set of request object methods to access data buffers, regardless of the buffer access method. Therefore, most drivers typically do not need to know whether UMDF is using buffered I/O or direct I/O for an I/O request.</p>
<p>In some cases, you can improve a driver's performance if you know the access method for an I/O request. For example, consider a high-throughput device that typically uses direct I/O. When the driver receives an I/O request,  it copies data from the shared buffer space into local driver memory for validation.</p>
<p>However, the driver might occasionally receive a buffer that uses buffered I/O. Because the I/O manager has already copied this data into an intermediate buffer, the driver does not need to copy the parameters locally. By avoiding the copy operation, the driver improves performance.</p>
<p>A UMDF driver calls <a href="wdf.wdfrequestgeteffectiveiotype"><b>WdfRequestGetEffectiveIoType</b></a> to obtain an I/O request's buffer access method. As described above, the I/O type for a specific request may differ from the framework-assigned I/O type settings for a device.</p>
<h2><a id="using_neither_buffered_i_o_nor_direct_i_o_in_umdf_drivers"></a><a id="USING_NEITHER_BUFFERED_I_O_NOR_DIRECT_I_O_IN_UMDF_DRIVERS"></a>
      Converting from Neither Buffered I/O nor Direct I/O</h2>
<p>A UMDF driver cannot use the "neither" method.</p>
<p>However, the <a href="kernel.defining_i_o_control_codes">definitions</a> of some device I/O control codes (IOCTLs) specify that the requests use the "neither" method. Optionally, a UMDF driver can convert the buffer access method of such device I/O control requests to buffered I/O or direct I/O. Use the following steps: </p>
<ol>
<li>
<p>Include the <a href="specifying_wdf_directives_in_inf_files.htm">UmdfMethodNeitherAction</a> directive in an <a href="devinst.inf_ddinstall_section"><b>INF DDInstall section</b></a> of your driver's INF file. You can set the directive's value to indicate that UMDF should pass device I/O control requests that use the "neither" access method to the driver. (Otherwise, UMDF completes these I/O requests with an error status value.) </p>
</li>
<li>
<p>Access the I/O request's buffers by using the object methods that UMDF provides for <a href="wdf.accessing_data_buffers_in_kmdf_drivers#buffered#buffered">buffered I/O</a> or <a href="wdf.accessing_data_buffers_in_kmdf_drivers#direct#direct">direct I/O</a>.</p>
</li>
</ol>
<p>You should enable support of IOCTL requests that use the "neither" method only if you are sure that UMDF can convert the access method to buffered I/O or direct I/O. For example, if the IOCTL specifies a customized request that does not follow the buffer specification rules that are described at <a href="kernel.buffer_descriptions_for_i_o_control_codes">Buffer Descriptions for I/O Control Codes</a>, UMDF cannot convert the buffers.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Managing Buffer Access Methods in UMDF Drivers%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
