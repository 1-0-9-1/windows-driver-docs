<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Surprise-Removal Sequence"/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Surprise-Removal Sequence</title>

<meta name="MS-HAID" content="kmdf.surprise-removal_sequence"/>
<meta name="MS-HAID" content="wdf.surprise-removal_sequence"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.surprise-removal_sequence"></a>Surprise-Removal Sequence</h1>
</div>
<p>If the user removes the device without warning, by simply unplugging it without using Device Manager or the Safely Remove Hardware utility, the device is considered "surprise-removed." When this occurs, the framework follows a slightly different removal sequence. It also follows the surprise-removal sequence if another driver calls <a href="kernel.ioinvalidatedevicestate"><b>IoInvalidateDeviceState</b></a> on the device, even if the device is still physically present.
In the surprise-removal sequence, the framework calls the <a href="wdf.evtdevicesurpriseremoval"><i>EvtDeviceSurpriseRemoval</i></a> callback before calling any of the other callbacks in the removal sequence. When the sequence is complete, the framework destroys the device object.
Drivers for all removable devices must ensure that the callbacks in both the shutdown and startup paths can handle failure, particularly failures that are caused by the removal of the hardware. Any attempts to access the hardware should not wait indefinitely, but should be subject to time-outs or a watchdog timer.
</p>
<p>The following diagram shows the callbacks that are involved in a surprise removal:</p>
<p><img src="images/surprise_removal.png" alt="Surprise-removal sequence"/></p>
<p>If the device was not in the working state when it was removed, the framework calls the <a href="wdf.evtdevicereleasehardware"><i>EvtDeviceReleaseHardware</i></a> event callback immediately after <a href="wdf.evtdevicesurpriseremoval"><i>EvtDeviceSurpriseRemoval</i></a>. It omits the intervening steps, which were already performed when the device exited from the working state.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Surprise-Removal Sequence%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
