<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Starting in Windows 10, you can build your KMDF or UMDF driver so that it gets additional driver debugging information through the Windows software trace preprocessing."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Using Inflight Trace Recorder (IFR) in KMDF and UMDF 2 Drivers</title>

<meta name="MS-HAID" content="wdf.using_wpp_software_tracing_in_kmdf_and_umdf_2_drivers"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.using_wpp_software_tracing_in_kmdf_and_umdf_2_drivers"></a>Using Inflight Trace Recorder (IFR) in KMDF and UMDF 2 Drivers</h1>
</div>
<p>
<p>Starting in Windows 10, you can build your KMDF or UMDF driver so that it gets additional driver debugging information through the Windows software trace preprocessing. This feature, called  the Inflight Trace Recorder (IFR), is available starting in KMDF version 1.15 and UMDF version 2.15.</p>
<p>Inflight Trace Recorder is an extension of <a href="devtest.wpp_software_tracing">WPP software tracing</a>. Unlike WPP tracing, the Inflight Trace Recorder continues to work without an attached trace consumer.  The framework writes messages to a circular buffer, and your driver can also add its own messages. Each driver has its own log, so multiple devices associated with a driver share a single log.</p>
<p>The logs are stored in non-pageable memory, so they are recoverable after a system crash.  In addition, Inflight Trace Recorder logs are included in minidump files.</p>
</p>
<p class="proch"><img src="../common/wedge.gif" alt=""/><b>How to enable Inflight Trace Recorder and send messages from your driver</b></p>
<ol>
<li>
<p>In  Microsoft Visual Studio, do the following:</p>
<ul>
<li>
<p>Open the Property Pages for your driver project. Right-click the driver project in Solution Explorer and select <b>Properties</b>.
In the Property Pages for the driver, click <b>Configuration Properties</b>, and then <b>Wpp Tracing</b>. On the <b>General</b> menu, set <b>Run WPP Tracing</b> to <b>Yes</b>.  </p>
</li>
<li>
<p>Navigate to <b>Properties-&gt;Wpp Tracing-&gt;Function and Macro Options</b> and choose <b>Enable WPP Recorder</b>.</p>
</li>
<li>
<p>On the same menu, set <b>Scan Configuration Data</b> to the file containing your trace information, for example Trace.h.</p>
</li>
</ul>
</li>
<li>
<p>In each source file that calls a WPP macro,  add an <b>#include</b> directive that identifies a <a href="devtest.trace_message_header_file">trace message header (TMH) file</a>. The file name must have a format of &lt;<i>driver-source-file-name</i>&gt;<b>.tmh</b>.</p>
<p>For example, if your driver consists of two source files, called <i>MyDriver1.c</i> and <i>MyDriver2.c</i>, then <i>MyDriver1.c</i> must contain:</p>
<p><b>#include "MyDriver1.tmh"</b></p>
<p>and <i>MyDriver2.c</i> must contain:</p>
<p><b>#include "MyDriver2.tmh"</b></p>
<p>When you build your driver in Visual Studio, the WPP preprocessor generates the .<i>tmh</i> files.</p>
</li>
<li>
<p>Define a <a href="devtest.wpp_control_guids">WPP_CONTROL_GUIDS</a> macro in a header file. This macro defines a GUID and <a href="devtest.trace_flags">trace flags</a> for your driver's tracing messages.</p>
<p>The Osrusbfx2 driver sample defines a single control GUID and seven trace flags in the Trace.h header file, as shown in the following example:
</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>#define WPP_CONTROL_GUIDS \
WPP_DEFINE_CONTROL_GUID(OsrUsbFxTraceGuid, \
  (d23a0c5a,d307,4f0e,ae8e,E2A355AD5DAB), \
  WPP_DEFINE_BIT(DBG_INIT)          /* bit  0 = 0x00000001 */ \
  WPP_DEFINE_BIT(DBG_PNP)           /* bit  1 = 0x00000002 */ \
  WPP_DEFINE_BIT(DBG_POWER)         /* bit  2 = 0x00000004 */ \
  WPP_DEFINE_BIT(DBG_WMI)           /* bit  3 = 0x00000008 */ \
  WPP_DEFINE_BIT(DBG_CREATE_CLOSE)  /* bit  4 = 0x00000010 */ \
  WPP_DEFINE_BIT(DBG_IOCTL)         /* bit  5 = 0x00000020 */ \
  WPP_DEFINE_BIT(DBG_WRITE)         /* bit  6 = 0x00000040 */ \
  WPP_DEFINE_BIT(DBG_READ)          /* bit  7 = 0x00000080 */ \
)
</pre>
</td>
</tr>
</table></span></div>
<p>In this example:</p>
<ul>
<li><b>OsrUsbFxTraceGuid</b> is the friendly name for the {d23a0c5a-d307-4f0e-ae8e-E2A355AD5DAB} GUID.</li>
<li>The trace flags are used to differentiate between trace messages that are generated as the driver handles different types of I/O requests.
</li>
</ul>
</li>
<li>
<p>Your driver (both KMDF and UMDF 2) must call <a href="devtest.wpp_init_tracing_for_kernel_mode_drivers"><b>WPP_INIT_TRACING for Kernel-Mode Drivers</b></a> with the driver object and a registry path, typically from <a href="wdf.driverentry_for_kmdf_drivers"><b>DriverEntry</b></a>:<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>WPP_INIT_TRACING( DriverObject, RegistryPath );</pre>
</td>
</tr>
</table></span></div>
</p>
<p>To deactivate tracing, both KMDF and UMDF 2 drivers call <a href="devtest.wpp_cleanup_for_kernel_mode_drivers"><b>WPP_CLEANUP for Kernel-Mode Drivers</b></a> from <a href="wdf.evtcleanupcallback"><i>EvtCleanupCallback</i></a> or <a href="wdf.evtdriverunload"><i>EvtDriverUnload</i></a>:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>WPP_CLEANUP( WdfDriverWdmGetDriverObject( Driver ));</pre>
</td>
</tr>
</table></span></div>
<p>The <a href="devtest.wpp_cleanup_for_kernel_mode_drivers"><b>WPP_CLEANUP</b></a> macro takes a parameter of type PDRIVER_OBJECT, so if your driver's <a href="wdf.driverentry_for_kmdf_drivers"><b>DriverEntry</b></a> fails, you can skip calling <a href="wdf.wdfdriverwdmgetdriverobject"><b>WdfDriverWdmGetDriverObject</b></a> and instead call <b>WPP_CLEANUP</b> with a pointer to the WDM driver object.</p>
<p>Starting in UMDF version 2.15, UMDF drivers use the kernel-mode signatures of these macros for initializing and cleaning up tracing. This means that the calls look identical for KMDF and UMDF.</p>
</li>
<li>
<p>Use the <a href="devtest.dotracemessage"><b>DoTraceMessage</b></a> macro, or a <a href="devtest.can_i_customize_dotracemessage_">customized version</a> of the macro, in your driver to create trace messages.</p>
<p>The following example shows how the Osrusbfx2 driver uses its <b>TraceEvents</b> function in a portion of the code devoted to handling read requests:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>if (Length &gt; TEST_BOARD_TRANSFER_BUFFER_SIZE) {
    TraceEvents(TRACE_LEVEL_ERROR,
                DBG_READ,
                "Transfer exceeds %d\n",
                TEST_BOARD_TRANSFER_BUFFER_SIZE);
 
    status = STATUS_INVALID_PARAMETER;
}
</pre>
</td>
</tr>
</table></span></div>
<p>The call to <b>TraceEvents</b> generates a trace message if the trace controller enables the <b>TRACE_LEVEL_ERROR</b> level and the <b>DBG_READ</b> trace flag. The message includes the value of the driver-defined constant <b>TEST_BOARD_TRANSFER_BUFFER_SIZE</b>.</p>
</li>
<li>
<p>To change the size of the circular buffer that the driver log uses, modify the <b>LogPages</b> registry value in the following registry location:</p>
<p><b>SOFTWARE\Microsoft\Windows NT\CurrentVersion\WUDF\Services\&lt;YourDriver&gt;</b></p>
<p>This is a value of type 	<b>REG_DWORD</b>	that contains the size of the log buffer allocated, in pages. Valid values are between 0x1 and 0x10.</p>
</li>
</ol>
<p class="proch"><img src="../common/wedge.gif" alt=""/><b>For a KMDF driver</b></p>
<ol>
<li>Load the RCDRKD commands by typing <b>.load rcdrkd.dll</b> in the debugger.</li>
<li>Use the <a href="debugger._wdfkd_wdfldr"><b>!wdfkd.wdfldr</b></a> extension to display information about the driver that are currently dynamically bound to Windows Driver Frameworks (WDF).</li>
<li>Use <a href="debugger._rcdrkd_rcdrlogdump"><b>!rcdrkd.rcdrlogdump</b></a> and <a href="debugger._rcdrkd_rcdrcrashdump"><b>!rcdrkd.rcdrcrashdump</b></a> to view messages that  the driver provides.</li>
<li>
<p>Use <a href="debugger._wdfkd_wdflogdump"><b>!wdfkd.wdflogdump</b></a> or <a href="debugger._wdfkd_wdfcrashdump"><b>!wdfkd.wdfcrashdump</b></a> to see messages that the framework provides.</p>
</li>
</ol>
<p class="proch"><img src="../common/wedge.gif" alt=""/><b>Live debugging of a UMDF driver</b></p>
<ol>
<li>Use the <a href="debugger._wdfkd_wdfldr"><b>!wdfkd.wdfldr</b></a> extension to display information about the driver that are currently dynamically bound to WDF.  Find your user-mode driver. Enter the associated host process.</li>
<li>
<p>Type <b>!wdfkd.wdflogdump </b><i>&lt;YourDriverName.dll&gt; &lt;Flag&gt;</i> , where <i>&lt;Flag&gt;</i> is:</p>
<ul>
<li>0x1 – Merged framework and driver logs</li>
<li>0x2 – Driver logs</li>
<li>0x3 – Framework logs</li>
</ul>
<p>If there is no driver log for the specified driver, the extension displays only the framework log.</p>
</li>
</ol>
<p class="proch"><img src="../common/wedge.gif" alt=""/><b>Viewing Inflight Trace Recorder logs after a UMDF driver crash</b></p>
<ol>
<li>From WinDbg, select <b>File-&gt;Open Crash Dump</b>, and specify the minidump file you would like to debug.</li>
<li>
<p>Type <a href="debugger._wdfkd_wdfcrashdump"><b>!wdfkd.wdfcrashdump <i>&lt;YourDriverName.dll&gt; &lt;process ID of driver host&gt; &lt;Option&gt; </i></b></a>, where <i>&lt;Option&gt;</i> is:</p>
<ul>
<li>0x1 – Merged framework and driver logs</li>
<li>0x2 – Driver logs</li>
<li>0x3 – Framework logs</li>
</ul>
<p>If you don't specify a driver, <a href="debugger._wdfkd_wdfcrashdump"><b>!wdfcrashdump</b></a> displays information for all drivers. If you don't specify a host process, and there is only one, the extension uses the single host process.  If you don't specify a host process and there is more than one, the extension lists the active host processes.</p>
<p>If the log information stored in the minidump does not match the entered name, the minidump does not contain the driver's logs.</p>
</li>
</ol>
<p>For more information about adding tracing messages to your driver, see <a href="devtest.adding_wpp_macros_to_a_trace_provider">Adding WPP Macros to a Driver</a>.</p>
<h2><a id="related_topics"></a>Related topics</h2>
<dl>
<dt><a href="enabling_a_debugger.htm">How to Enable Debugging of a UMDF Driver</a></dt>
<dt><a href="debugger.rcdrkd_extensions">RCDRKD Extensions</a></dt>
<dt><a href="using_the_framework_s_event_logger.htm">Using the Framework's Event Logger</a></dt>
<dt><a href="using_wpp_software_tracing_in_umdf_drivers.htm">Using WPP Software Tracing in UMDF Drivers</a></dt>
</dl>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Using Inflight Trace Recorder (IFR) in KMDF and UMDF 2 Drivers%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
