<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Using Device Pooling in UMDF Drivers"/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Using Device Pooling in UMDF Drivers</title>

<meta name="MS-HAID" content="umdf.using_device_pooling_in_umdf_drivers"/>
<meta name="MS-HAID" content="wdf.using_device_pooling_in_umdf_drivers"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.using_device_pooling_in_umdf_drivers"></a>Using Device Pooling in UMDF Drivers</h1>
</div>
<h2><a id="User-Mode_Driver_Framework__UMDF__Versions_1.11_and_2.0"></a><a id="user-mode_driver_framework__umdf__versions_1.11_and_2.0"></a><a id="USER-MODE_DRIVER_FRAMEWORK__UMDF__VERSIONS_1.11_AND_2.0"></a>User-Mode Driver Framework (UMDF) Versions 1.11 and 2.0</h2>
<p>If your User-Mode Driver Framework (UMDF) driver was built with version 1.11 or 2.0 and is running on Windows 8 or later, the framework creates a single instance of Wudfhost that can host multiple device stacks. This technique is called <i>device pooling</i>.  The main benefit of device pooling is reduced memory consumption in an environment with multiple UMDF devices.</p>
<p>If a pooled device fails, the framework terminates the instance of Wudfhost and attempts to restart all of the devices that were previously in the pool. If the device fails again while pooled, the framework creates a separate Wudfhost process for the device and attempts to start the device again.</p>
<p>If the device fails in the separate host process, the framework attempts to restart it up to five times. The framework resets the device error count to one when thirty minutes have elapsed since the last failure.</p>
<p>If the system is rebooted, the framework repools devices except for those  that have failed while running in a separate process.</p>
<p>To disable device pooling for a specific device, use the <b>UmdfHostProcessSharing</b> directive in the WDF-specific <i>DDInstall</i> section of the INF. For information about <b>UmdfHostProcessSharing</b>, see <a href="specifying_wdf_directives_in_inf_files.htm">Specifying WDF Directives in INF Files</a>.</p>
<p>If your driver uses <a href="wdf.accessing_data_buffers_in_umdf_drivers">direct I/O</a>, you must set <b>UmdfHostProcessSharing</b> to <b>ProcessSharingDisabled</b>. Otherwise your driver may fail to start. If <b>WdfDeviceIoBufferedOrDirect</b> is selected and the device is pooled, the framework changes the buffer access method to <a href="wdf.accessing_data_buffers_in_umdf_drivers">buffered I/O</a>. If <b>WdfDeviceIoBufferedOrDirect</b> is selected and the device is not pooled, the framework changes the buffer access method to direct I/O.</p>
<p>To select a buffer access method, your driver must call the <a href="wdf.iwdfdeviceinitialize2_setiotypepreference"><b>IWDFDeviceInitialize2::SetIoTypePreference</b></a> method from its <a href="wdf.idriverentry_ondeviceadd"><b>IDriverEntry::OnDeviceAdd</b></a> callback function. For information about access methods, see <a href="wdf.accessing_data_buffers_in_umdf_drivers">Accessing Data Buffers in UMDF-Based Drivers</a>.</p>
<h2><a id="UMDF_Versions_1.9_and_earlier"></a><a id="umdf_versions_1.9_and_earlier"></a><a id="UMDF_VERSIONS_1.9_AND_EARLIER"></a>UMDF Versions 1.9 and earlier</h2>
<p>If your driver was built with UMDF version 1.9 or earlier, the framework creates a separate instance of the host process (Wudfhost) for each device stack.</p>
<p>If the device fails to start, the framework attempts to restart it up to five times. The framework resets the device error count to one when thirty minutes have elapsed since the last  failure.</p>
<p>In a non-pooled environment, if multiple device stacks share the same UMDF driver:</p>
<ul>
<li>Each device stack loads in a separate WudfHost process.</li>
<li>The framework calls the driver’s <a href="wdf.idriverentry_oninitialize"><b>IDriverEntry::OnInitialize</b></a> and <a href="wdf.idriverentry_ondeinitialize"><b>IDriverEntry::OnDeinitialize</b></a> methods once for each device stack.</li>
<li>The framework calls the driver’s <a href="wdf.idriverentry_ondeviceadd"><b>IDriverEntry::OnDeviceAdd</b></a> method once for each device stack. Each device object is associated with a separate driver object.</li>
</ul>
<p>
In a pooled environment, if multiple device stacks share the same user mode driver:</p>
<ul>
<li>Each device stack loads in the same WudfHost process.</li>
<li>The framework calls the driver’s <a href="wdf.idriverentry_oninitialize"><b>IDriverEntry::OnInitialize</b></a> and <a href="wdf.idriverentry_ondeinitialize"><b>IDriverEntry::OnDeinitialize</b></a> methods only once.</li>
<li>The framework calls the driver’s <a href="wdf.idriverentry_ondeviceadd"><b>IDriverEntry::OnDeviceAdd</b></a> method once for each device stack. Each device object is associated with the same driver object.</li>
</ul>
<p>Because there is only one driver object in a pooled configuration, the driver must not store any per-device context in global variables or in objects that are shared across the devices, such as the driver callback object. Instead, the driver must store per-device context in an object that is not shared between the device stacks, such as the driver’s device callback object.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Using Device Pooling in UMDF Drivers%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
