<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="System-mode DMA, in contrast to bus-master DMA, describes a configuration in which multiple devices share a single, typically multichannel DMA controller.Starting in Kernel-Mode Driver Framework (KMDF) version 1.11, the framework supports system-mode DMA on System on a Chip (SoC)–based systems running on Windows 8 or later versions of the Windows operating system.This topic describes the code that a KMDF driver must provide in its event callback functions, as well as optional event callback functions it can register, to handle I/O requests for a system-mode DMA device."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Supporting System-Mode DMA</title>

<meta name="MS-HAID" content="kmdf.supporting_system-mode_dma"/>
<meta name="MS-HAID" content="wdf.supporting_system-mode_dma"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.supporting_system-mode_dma"></a>Supporting System-Mode DMA</h1>
</div>
<p class="CCE_Message">[Applies to KMDF only]</p>
<p>
<p>System-mode DMA, in contrast to <i>bus-master</i> DMA, describes a configuration in which multiple devices share a single, typically multichannel DMA controller.</p>
<p>Starting in Kernel-Mode Driver Framework (KMDF) version 1.11, the framework supports system-mode DMA on System on a Chip (SoC)–based systems running on Windows 8 or later versions of the Windows operating system.</p>
<p>This topic describes the code that a KMDF driver must provide in its event callback functions, as well as optional event callback functions it can register, to handle I/O requests for a system-mode DMA device.</p>
</p>
<p>For information about KMDF and bus-master DMA, see <a href="handling_i_o_requests_in_a_kmdf_driver_for_a_bus_master_dma_device.htm">Handling I/O Requests in a KMDF Driver for a Bus-Master DMA Device</a>.</p>
<p>The following figure shows the event callback functions that your driver uses to support system-mode DMA:</p><img src="images/sys_mode_dma_in_kmdf.png" alt="System-mode DMA Implementation in KMDF drivers"/><h2><a id="creating_a_system-mode_dma_enabler"></a><a id="CREATING_A_SYSTEM-MODE_DMA_ENABLER"></a>Creating a System-Mode DMA Enabler</h2>
<p>Creating a system-mode DMA profile is a two-step process. The following steps represent a typical scenario:</p>
<ol>
<li>
<p>Typically in its <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a> callback function, the driver calls <a href="wdf.wdf_dma_enabler_config_init"><b>WDF_DMA_ENABLER_CONFIG_INIT</b></a>, setting the <b>Profile</b> parameter to <b>SystemMode</b> or <b>SystemModeDuplex</b>.  The driver then calls <a href="wdf.wdfdmaenablercreate"><b>WdfDmaEnablerCreate</b></a>, passing the <a href="wdf.wdf_dma_enabler_config"><b>WDF_DMA_ENABLER_CONFIG</b></a> structure that it just received.</p>
<p> The driver might alternatively create the enabler during <a href="wdf.evtdevicepreparehardware"><i>EvtDevicePrepareHardware</i></a>.</p>
</li>
<li>
<p>Your driver's <a href="wdf.evtdevicepreparehardware"><i>EvtDevicePrepareHardware</i></a> callback function associates the DMA enabler with its DMA resources by calling the  <a href="wdf.wdfdmaenablerconfiguresystemprofile"><b>WdfDmaEnablerConfigureSystemProfile</b></a> method.            For a duplex enabler, the driver calls <a href="wdf.wdfdmaenablerconfiguresystemprofile"><b>WdfDmaEnablerConfigureSystemProfile</b></a> twice, once to configure each transfer direction.</p>
<p>The driver can call <a href="wdf.wdfdmaenablerconfiguresystemprofile"><b>WdfDmaEnablerConfigureSystemProfile</b></a> after <a href="wdf.evtdevicepreparehardware"><i>EvtDevicePrepareHardware</i></a> has completed, but the driver must call this method before it initializes DMA transactions.</p>
</li>
</ol>
<h2><a id="Providing_Optional_Callback_Functions"></a><a id="providing_optional_callback_functions"></a><a id="PROVIDING_OPTIONAL_CALLBACK_FUNCTIONS"></a>Providing Optional Callback Functions</h2>
<h3><a id="configuring_a_system-mode_dma_enabler"></a><a id="CONFIGURING_A_SYSTEM-MODE_DMA_ENABLER"></a>Configuring a DMA Channel</h3>
<p>Typically, KMDF drivers do not configure DMA channels.  However, in certain circumstances, drivers may need to perform channel-specific configuration. For example, a driver might call a custom function that is implemented by the DMA controller by using the following steps:</p>
<ol>
<li>In one of the driver's <a href="request_handlers.htm">request handlers</a>, the driver calls <a href="wdf.wdfdmatransactionsetchannelconfigurationcallback"><b>WdfDmaTransactionSetChannelConfigurationCallback</b></a> to register a <a href="wdf.evtdmatransactionconfiguredmachannel"><i>EvtDmaTransactionConfigureDmaChannel</i></a> callback function.</li>
<li>Your driver's <a href="wdf.evtdmatransactionconfiguredmachannel"><i>EvtDmaTransactionConfigureDmaChannel</i></a> callback function calls <a href="wdf.wdfdmaenablerwdmgetdmaadapter"><b>WdfDmaEnablerWdmGetDmaAdapter</b></a> to retrieve a pointer to the WDM <a href="kernel.dma_adapter"><b>DMA_ADAPTER</b></a>. This structure is the adapter object that represents the driver's system-mode DMA channel.</li>
<li>The driver can then call <a href="kernel.configureadapterchannel"><b>ConfigureAdapterChannel</b></a> to enable custom functions implemented by the DMA controller. This routine is callable only by pointer from the address returned in a <a href="kernel.dma_operations"><b>DMA_OPERATIONS</b></a> structure.</li>
<li>Your driver's <a href="wdf.evtdmatransactionconfiguredmachannel"><i>EvtDmaTransactionConfigureDmaChannel</i></a> callback function returns TRUE if it successfully configures the DMA channel.</li>
<li>The framework calls the driver's <a href="wdf.evtprogramdma"><i>EvtProgramDma</i></a> callback function.</li>
</ol>
<h3><a id="receiving_notification_of_transfer_completion"></a><a id="RECEIVING_NOTIFICATION_OF_TRANSFER_COMPLETION"></a>Receiving Notification of Transfer Completion</h3>
<p>Unlike devices that use bus-mastering controllers, the hardware for a system-mode DMA device might not signal DMA transfer completion by issuing an interrupt.</p>
<p> If your device does not raise an interrupt to signal DMA transfer completion, your driver can provide an <a href="wdf.evtdmatransactiondmatransfercomplete"><i>EvtDmaTransactionDmaTransferComplete</i></a> event callback function that the framework calls when a system-mode DMA transfer has completed.</p>
<p>To register this callback function, a driver calls <a href="wdf.wdfdmatransactionsettransfercompletecallback"><b>WdfDmaTransactionSetTransferCompleteCallback</b></a> from one of its <a href="request_handlers.htm">request handlers</a>.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Supporting System-Mode DMA%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
