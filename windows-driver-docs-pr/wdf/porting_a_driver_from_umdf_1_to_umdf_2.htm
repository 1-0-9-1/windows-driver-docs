<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="This topic describes how to port a User-Mode Driver Framework (UMDF) 1 driver to UMDF 2."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Porting a Driver from UMDF 1 to UMDF 2</title>

<meta name="MS-HAID" content="wdf.porting_a_driver_from_umdf_1_to_umdf_2"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.porting_a_driver_from_umdf_1_to_umdf_2"></a>Porting a Driver from UMDF 1 to UMDF 2</h1>
</div>
<div class="nav_sidebar" style="background: #ebeff0; border: 1px #e3e3e3 solid; padding: 5px; float: right; margin-left: 10px; width: 290px;"><span class="sidebar_heading" style="font-weight: bold;">In this article</span><div class="sidebar_toc">
<p>
<ul>
<li><a href="#getting_started">Getting Started</a></li>
<li><a href="#managing_object_lifetime">Managing Object Lifetime</a></li>
<li><a href="#driver_initialization">Driver Initialization</a></li>
<li><a href="#installing_your_driver">Installing your driver</a></li>
<li><a href="#storing_device_context">Storing Device Context</a></li>
<li><a href="#debugging_your_driver">Debugging your driver</a></li>
<li><a href="#related_topics">Related topics</a></li>
</ul>
</p>
</div>
</div>
<p>This topic describes how to port a User-Mode Driver Framework (UMDF) 1 driver to UMDF 2.  You can start with a UMDF 1 driver that uses Sources/Dirs files (not a Visual Studio project), or you can convert a UMDF 1 driver that is contained in a Visual Studio project.  The result will be a UMDF 2 driver project in Visual Studio. UMDF 2 drivers run on both Windows 10 for desktop editions (Home, Pro, Enterprise, and Education) and Windows 10 Mobile.</p>
<p>The Echo driver sample is an example of a driver that has been ported from UMDF 1 to UMDF 2.</p>
<ul>
<li><a href="http://go.microsoft.com/fwlink/p/?LinkId=617707">Echo Sample (UMDF Version 1)</a></li>
<li><a href="http://go.microsoft.com/fwlink/p/?LinkId=617708">Echo Sample (UMDF Version 2)</a></li>
</ul>
<p></p>
<h2><a id="Getting_Started"></a><a id="getting_started"></a><a id="GETTING_STARTED"></a>Getting Started</h2>
<p>To start, open a new driver project in Visual Studio.  Select the <b>Visual C++-&gt;Windows Driver-&gt;WDF-&gt;User Mode Driver (UMDF 2)</b> template.  Visual Studio opens a partially populated template that includes stubs for the callback functions that your driver must implement.  This new driver project will be the foundation of your UMDF 2 driver.   Use the UMDF 2 Echo sample as a guide to the type of code you should introduce.</p>
<p>Next, review your existing UMDF 1 driver code and determine object mappings. Each COM object in UMDF 1 has a corresponding WDF object in UMDF 2. For example, the <b>IWDFDevice</b> interface maps to the WDF device object, which is represented by a WDFDEVICE handle.  Nearly all framework-supplied interface methods in UMDF 1 have corresponding methods in UMDF 2.   For example, <a href="wdf.iwdfdevice_getdefaultioqueue"><b>IWDFDevice::GetDefaultIoQueue</b></a> maps to <a href="wdf.wdfdevicegetdefaultqueue"><b>WdfDeviceGetDefaultQueue</b></a>.    </p>
<p>Similarly, driver-supplied  callback functions have equivalents in the two versions. In UMDF 1, the naming convention for driver-supplied interfaces (except for <b>IDriverEntry</b>) is <i>I<i>Object</i>Callback<i>Xxx</i></i>, while in UMDF 2 the naming convention for driver-supplied routines is <i>Evt<i>ObjectXxx</i></i>.  For example, the <a href="wdf.idriverentry_ondeviceadd"><b>IDriverEntry::OnDeviceAdd</b></a>  callback method maps to <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a>.</p>
<p>Your driver implements callback functions in both UMDF 1 and 2, but the way that the driver supplies pointers to its callbacks differs. In UMDF 1, the driver implements callback methods as members of driver-supplied interfaces.  The driver registers these interfaces with the framework when it creates framework objects, for example by calling <a href="wdf.iwdfdriver_createdevice"><b>IWDFDriver::CreateDevice</b></a>.</p>
<p>In UMDF 2, the driver provides pointers to driver-supplied callback functions  in configuration structures such as <a href="wdf.wdf_driver_config"><b>WDF_DRIVER_CONFIG</b></a>  and <a href="wdf.wdf_io_queue_config"><b>WDF_IO_QUEUE_CONFIG</b></a>.</p>
<h2><a id="Managing_Object_Lifetime"></a><a id="managing_object_lifetime"></a><a id="MANAGING_OBJECT_LIFETIME"></a>Managing Object Lifetime</h2>
<p>Drivers that use UMDF 1 must implement reference counting in order to determine when it is safe to delete objects. Because the framework tracks object references on the driver's behalf, a UMDF 2 driver does not need to count references.   </p>
<p>In UMDF 2, each framework object has a default parent object.  When a parent object is deleted, the framework deletes associated child objects.  When your driver calls an object creation method such as <a href="wdf.wdfdevicecreate"><b>WdfDeviceCreate</b></a>, it can  accept the default parent, or it can specify a custom parent in a <a href="wdf.wdf_object_attributes"><b>WDF_OBJECT_ATTRIBUTES</b></a> structure. For a list of framework objects and their default parent objects, see <a href="summary_of_framework_objects.htm">Summary of Framework Objects</a>.</p>
<h2><a id="Driver_Initialization"></a><a id="driver_initialization"></a><a id="DRIVER_INITIALIZATION"></a>Driver Initialization</h2>
<p>A UMDF 1 driver implements the <a href="wdf.idriverentry"><b>IDriverEntry</b></a> interface.  In its <a href="wdf.idriverentry_ondeviceadd"><b>IDriverEntry::OnDeviceAdd</b></a> callback method, the driver typically:</p>
<ul>
<li>Creates and initializes an instance of the device callback object.</li>
<li>Creates the new framework device object by calling <a href="wdf.iwdfdriver_createdevice"><b>IWDFDriver::CreateDevice</b></a>.</li>
<li>Sets up the device's queues and their corresponding callback objects.</li>
<li>Creates an instance of a device interface class by calling <a href="wdf.iwdfdevice_createdeviceinterface"><b>IWDFDevice::CreateDeviceInterface</b></a>.</li>
</ul>
<p>A UMDF 2 driver implements <a href="wdf.driverentry_for_kmdf_drivers"><b>DriverEntry</b></a> and <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a>. In its <b>DriverEntry</b> routine, a UMDF 2 driver typically calls <a href="wdf.wdf_driver_config_init"><b>WDF_DRIVER_CONFIG_INIT</b></a> to initialize the driver's <a href="wdf.wdf_driver_config"><b>WDF_DRIVER_CONFIG</b></a> structure.  Then it passes this structure to <a href="wdf.wdfdrivercreate"><b>WdfDriverCreate</b></a>.</p>
<p>In its <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a>  function, the driver might do some of the following:<ul>
<li>Fill in the <a href="wdf.wdfdevice_init">WDFDEVICE_INIT</a> structure, which supplies information that is used to create the device object. For more information about using WDFDEVICE_INIT, see <a href="creating_a_framework_device_object.htm">Creating a Framework Device Object</a>.</li>
<li>Set up the device object’s context area. For  information about allocating and accessing context space for framework objects, see <a href="framework_object_context_space.htm">Framework Object Context Space</a>.</li>
<li><a href="creating_a_framework_device_object.htm">Create the device object</a>.</li>
<li>Specify <a href="request_handlers.htm">request handlers</a> for the device object.</li>
<li><a href="creating_i_o_queues.htm">Create I/O queues</a>.</li>
<li><a href="using_device_interfaces.htm">Create device interfaces</a>.</li>
<li>Set <a href="supporting_idle_power_down.htm">device idle policy</a> and <a href="supporting_system_wake_up.htm">wake settings</a>, if the device object owns power policy.</li>
<li><a href="creating_an_interrupt_object.htm">Create interrupt objects</a>, if the hardware supports interrupts.</li>
</ul>
</p>
<h2><a id="Installing_your_driver"></a><a id="installing_your_driver"></a><a id="INSTALLING_YOUR_DRIVER"></a>Installing your driver</h2>
<p>When you create a new driver project in Visual Studio, the new project contains an .inx file.  When you build your driver, Visual Studio compiles your .inx file into an INF file that can be used as part of a driver package.</p>
<p> While  an INF file for a UMDF 1 driver must include a driver class ID, a DriverCLSID is not required in an INF file for a UMDF 2 driver.</p>
<p>Also, although   a UMDF 1 driver must reference the  co-installer in its INF file, no constaller reference is required in a UMDF 2 INF file.   Though a coinstaller reference can appear in an INF file for a UMDF 2 driver, one is not required.</p>
<h2><a id="Storing_Device_Context"></a><a id="storing_device_context"></a><a id="STORING_DEVICE_CONTEXT"></a>Storing Device Context</h2>
<p>In UMDF 1, the driver usually stores device context in a driver-created callback object, for example by specifying private members of the device callback object class. Alternatively, a UMDF 1 driver can call the <a href="wdf.iwdfobject_assigncontext"><b>IWDFObject::AssignContext</b></a> method to register context on a framework object.

</p>
<p> In UMDF 2, the framework allocates context space based on the optional <a href="wdf.wdf_object_attributes"><b>WDF_OBJECT_ATTRIBUTES</b></a>  structure that the driver provides when it calls an object creation method. After  calling an object's create method, a driver can call  <a href="wdf.wdfobjectallocatecontext"><b>WdfObjectAllocateContext</b></a> one or more times to allocate additional context space to a specific object. For the steps a UMDF 2 driver should use to define a context structure and accessor method, see <a href="framework_object_context_space.htm">Framework Object Context Space</a>.    </p>
<h2><a id="Debugging_your_driver"></a><a id="debugging_your_driver"></a><a id="DEBUGGING_YOUR_DRIVER"></a>Debugging your driver</h2>
<p>To debug a UMDF 2 driver, you'll use extensions in Wdfkd.dll instead of Wudfext.dll.  For more info about extensions in Wudfext.dll, see <a href="debugger_extensions_for_kmdf_drivers.htm">Summary of Debugger Extensions in Wdfkd.dll</a>.</p>
<p>In UMDF 2, you can also get additional driver debugging information through the Inflight Trace Recorder (IFR), as described in <a href="using_wpp_software_tracing_in_kmdf_and_umdf_2_drivers.htm">Using Inflight Trace Recorder in KMDF and UMDF 2 Drivers</a>.    Also, you 
can use the framework's own <i>In-flight Recorder</i> (IFR).    See <a href="using_the_framework_s_event_logger.htm">Using the Framework's Event Logger</a>.</p>
<h2><a id="related_topics"></a>Related topics</h2>
<dl>
<dt><a href="getting_started_with_umdf_version_2.htm">Getting Started with UMDF</a></dt>
<dt><a href="framework_object_context_space.htm">Framework Object Context Space</a></dt>
<dt><a href="umdf_version_history.htm">UMDF Version History</a></dt>
<dt><a href="framework_objects.htm">Framework Objects</a></dt>
</dl>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Porting a Driver from UMDF 1 to UMDF 2%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
