<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Example Uses of I/O Queues"/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Example Uses of I/O Queues</title>

<meta name="MS-HAID" content="Ch3_DFIoPackage_794acee3-7f37-496d-8ac6-bfb77131dc88.xml"/>
<meta name="MS-HAID" content="kmdf.example_uses_of_i_o_queues"/>
<meta name="MS-HAID" content="wdf.example_uses_of_i_o_queues"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.example_uses_of_i_o_queues"></a>Example Uses of I/O Queues</h1>
</div>
<h2><a id="ddk_example_uses_of_i_o_queues_df"></a><a id="DDK_EXAMPLE_USES_OF_I_O_QUEUES_DF"></a></h2>
<p>For each device that is connected to a system and supported by a particular driver, the driver can use the following combinations of I/O queues and <a href="request_handlers.htm">request handlers</a>:</p>
<ul>
<li>
<p>A single, default I/O queue and a single request handler, <a href="wdf.evtiodefault"><i>EvtIoDefault</i></a>. The framework will deliver all of the device's requests to the default queue, and it will call the driver's <i>EvtIoDefault</i> handler to deliver each request to the driver.</p>
</li>
<li>
<p>A single, default I/O queue and multiple request handlers such as <a href="wdf.evtioread"><i>EvtIoRead</i></a>, <a href="wdf.evtiowrite"><i>EvtIoWrite</i></a>, and <a href="wdf.evtiodevicecontrol"><i>EvtIoDeviceControl</i></a>. The framework will deliver all of the device's requests to the default queue. It will call the driver's <i>EvtIoRead</i> handler to deliver read requests, the <i>EvtIoWrite</i> handler to deliver write requests, and the <i>EvtIoDeviceControl</i> handler to deliver device I/O control requests.</p>
</li>
<li>
<p>Multiple I/O queues, such as one for read requests and another for write requests. For each queue, the driver provides only one request handler because the queue receives only one type of request.</p>
</li>
<li>
<p>Multiple I/O queues, each with multiple request handlers.</p>
</li>
</ul>
<p>Some example scenarios include:</p>
<dl>
<dd>
<p><a href="#a_single_sequential_i_o_queue">A Single Sequential I/O Queue</a></p>
</dd>
<dd>
<p><a href="#multiple_sequential_i_o_queues_and_a_manual_queue">Multiple Sequential I/O Queues and a Manual Queue</a></p>
</dd>
<dd>
<p><a href="#a_single_parallel_i_o_queue">A Single Parallel I/O Queue</a></p>
</dd>
<dd>
<p><a href="#multiple_parallel_i_o_queues">Multiple Parallel I/O Queues</a></p>
</dd>
</dl>
<h3><a id="a_single_sequential_i_o_queue"></a><a id="A_SINGLE_SEQUENTIAL_I_O_QUEUE"></a>A Single Sequential I/O Queue</h3>
<p>If you are writing a function driver for a disk drive that can only service read and write requests one at a time, the function driver needs only one I/O queue per device.</p>
<p>The driver can use the default I/O queue that the framework creates when the driver calls <a href="wdf.wdfioqueuecreate"><b>WdfIoQueueCreate</b></a> and sets <b>DefaultQueue</b> to <b>TRUE</b> in the queue's <a href="wdf.wdf_io_queue_config"><b>WDF_IO_QUEUE_CONFIG</b></a> structure. In the WDF_IO_QUEUE_CONFIG structure, the driver should also specify:</p>
<ul>
<li>
<p><b>WdfIoQueueDispatchSequential</b> as the dispatching method, so the default I/O queue will deliver I/O requests to the driver synchronously.</p>
</li>
<li>
<p>A single event callback function, <a href="wdf.evtiodefault"><i>EvtIoDefault</i></a>, that will receive all I/O requests.</p>
</li>
</ul>
<p>Each time an I/O request is available in the driver's default I/O queue, the framework will deliver the request to the driver by calling the driver's <a href="wdf.evtiodefault"><i>EvtIoDefault</i></a> request handler. If another request becomes available in the queue, the framework will not deliver it until the driver calls <a href="wdf.wdfrequestcomplete"><b>WdfRequestComplete</b></a> for the previously delivered request.</p>
<h3><a id="multiple_sequential_i_o_queues_and_a_manual_queue"></a><a id="MULTIPLE_SEQUENTIAL_I_O_QUEUES_AND_A_MANUAL_QUEUE"></a>Multiple Sequential I/O Queues and a Manual Queue</h3>
<p>Consider a serial port device that has the following characteristics:</p>
<ul>
<li>
<p>It can simultaneously perform one read operation and one write operation.</p>
</li>
<li>
<p>It cannot perform multiple read or write operations asynchronously.</p>
</li>
<li>
<p>It can receive device I/O control requests for status information. The device's driver might take a long time to complete some of these requests (such as a request to wait for a status change).</p>
</li>
</ul>
<p>A function driver for this device could use multiple, sequential I/O queues per device. The driver would call <a href="wdf.wdfioqueuecreate"><b>WdfIoQueueCreate</b></a> three times: once to create a default queue and twice to create two additional I/O queues. In the <a href="wdf.wdf_io_queue_config"><b>WDF_IO_QUEUE_CONFIG</b></a> structure for each of these queues, the driver should specify:</p>
<ul>
<li>
<p><b>WdfIoQueueDispatchSequential</b> as the dispatching method for each queue, so that the framework will deliver I/O requests to the driver synchronously.</p>
</li>
<li>
<p>A different <a href="request_handlers.htm">request handler</a> for each queue (<a href="wdf.evtiodefault"><i>EvtIoDefault</i></a>, <a href="wdf.evtioread"><i>EvtIoRead</i></a>, and <a href="wdf.evtiowrite"><i>EvtIoWrite</i></a>), which will receive the queue's I/O requests.</p>
</li>
</ul>
<p>After calling <a href="wdf.wdfioqueuecreate"><b>WdfIoQueueCreate</b></a>, the driver could call <a href="wdf.wdfdeviceconfigurerequestdispatching"><b>WdfDeviceConfigureRequestDispatching</b></a> twice - to forward all read requests to one of the additional queues and all write requests to the other.</p>
<p>With this configuration, the device's default I/O queue <a href="wdf.evtiodefault"><i>EvtIoDefault</i></a> callback function will receive only the device I/O control requests for status information. </p>
<p>If the driver has to hold a status request for a long time, it can create a fourth queue and specify <b>WdfIoQueueDispatchManual</b> as the dispatching method. When the driver receives a request for information that it must wait for, it can place the request in this extra queue until the status information becomes available. Then the driver can retrieve the request from the queue and complete it. In the meantime, the default queue can deliver another request to the driver.</p>
<h3><a id="a_single_parallel_i_o_queue"></a><a id="A_SINGLE_PARALLEL_I_O_QUEUE"></a>A Single Parallel I/O Queue</h3>
<p>IDE disk controllers can overlap some I/O operations, but not others. For example, while a controller is processing a read or write operation on one disk, it can send a seek command to another disk. On the other hand, multiple, simultaneous read and write commands are not supported. </p>
<p>A function driver for this controller must examine each I/O request. If the driver receives a seek command, it must determine if the seek command can be processed. The seek command cannot be processed if:</p>
<ul>
<li>
<p>The specified disk drive is already busy.</p>
</li>
<li>
<p>A disk drive is being formatted and, therefore, no other drives can be active.</p>
</li>
</ul>
<p>For each device that is connected to the controller, the driver could call <a href="wdf.wdfioqueuecreate"><b>WdfIoQueueCreate</b></a> to create a default I/O queue. In the <a href="wdf.wdf_io_queue_config"><b>WDF_IO_QUEUE_CONFIG</b></a> structure for each of these queues, the driver should specify:</p>
<ul>
<li>
<p><b>WdfIoQueueDispatchParallel</b> as the dispatching method for each queue, so that the framework will deliver I/O requests to the driver asynchronously.</p>
</li>
<li>
<p>An <a href="wdf.evtiodefault"><i>EvtIoDefault</i></a> event callback function for each queue, which will receive the queue's I/O requests.</p>
</li>
</ul>
<p>With this configuration, a single, parallel I/O queue is assigned to each device. The driver must examine each I/O request that the framework delivers from each I/O queue. If the driver can process the request immediately, it does so. Otherwise, the driver calls <a href="wdf.wdfioqueuestop"><b>WdfIoQueueStop</b></a>, which causes the framework to stop delivering requests until the driver calls <a href="wdf.wdfioqueuestart"><b>WdfIoQueueStart</b></a>.</p>
<h3><a id="multiple_parallel_i_o_queues"></a><a id="MULTIPLE_PARALLEL_I_O_QUEUES"></a>Multiple Parallel I/O Queues</h3>
<p>A SCSI host adapter is an example of a device that supports asynchronous, overlapped I/O operations. Up to 32 devices can be connected to the adapter. Consider a system with the following configuration:</p>
<ul>
<li>
<p>Some of the devices connected to the SCSI adapter support "reselection", and some do not. If a SCSI device supports reselection, then during an I/O operation the device can temporarily release the adapter so the adapter can service another device. The first device later reselects itself to finish its operation. </p>
</li>
<li>
<p>The SCSI adapter uses hardware mailboxes to pass requests and responses between the driver and the devices. If a device is ready for a request but there are no available mailboxes, the device must wait.</p>
</li>
</ul>
<p>For best performance, the function driver for this SCSI host adapter should receive I/O requests from the framework as soon as they are available. The driver must examine each request and determine if it can be started immediately or must be postponed until the device and resources (such as mailbox memory) are available.</p>
<p>The driver should probably use multiple, parallel I/O queues. For each device that is connected to the adapter, the driver would call <a href="wdf.wdfioqueuecreate"><b>WdfIoQueueCreate</b></a> to create a default I/O queue. In the <a href="wdf.wdf_io_queue_config"><b>WDF_IO_QUEUE_CONFIG</b></a> structure for each of these queues, the driver should specify:</p>
<ul>
<li>
<p><b>WdfIoQueueDispatchParallel</b> as the dispatching method for each queue, so that the framework will deliver I/O requests to the driver asynchronously.</p>
</li>
<li>
<p>An <a href="wdf.evtiodefault"><i>EvtIoDefault</i></a> event callback function for each queue, which will receive the queue's I/O requests.</p>
</li>
</ul>
<p>Each I/O queue's <a href="wdf.evtiodefault"><i>EvtIoDefault</i></a> callback function must examine the queue's I/O requests, as they are delivered, and determine whether each one can be serviced immediately. If the device and system resources are available, the driver starts the I/O operation. If the device or resources are not available, the driver must call <a href="wdf.wdfioqueuestop"><b>WdfIoQueueStop</b></a> to stop delivery of additional requests until the current one can be processed.</p>
<p>Optionally, the driver can call <a href="wdf.wdfioqueuecreate"><b>WdfIoQueueCreate</b></a> to create additional queues for each device. Then the driver can call <a href="wdf.wdfrequestforwardtoioqueue"><b>WdfRequestForwardToIoQueue</b></a> to requeue some types of requests to the additional queues. When the framework delivers requests from an additional queue, the driver can call <a href="wdf.wdfioqueuestop"><b>WdfIoQueueStop</b></a>, if necessary, on that queue instead of the default queue, thereby minimizing the number or type of requests for which delivery is postponed.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Example Uses of I/O Queues%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
