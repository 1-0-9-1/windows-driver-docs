<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Synchronizing Cancel and Completion Code"/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Synchronizing Cancel and Completion Code</title>

<meta name="MS-HAID" content="Ch3_DFIoPackage_1c14803a-1aeb-4d87-be49-b011f31f8f55.xml"/>
<meta name="MS-HAID" content="kmdf.synchronizing_cancel_and_completion_code"/>
<meta name="MS-HAID" content="wdf.synchronizing_cancel_and_completion_code"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.synchronizing_cancel_and_completion_code"></a>Synchronizing Cancel and Completion Code</h1>
</div>
<h2><a id="ddk_synchronizing_cancel_and_completion_code_df"></a><a id="DDK_SYNCHRONIZING_CANCEL_AND_COMPLETION_CODE_DF"></a></h2>
<p>If your driver calls <a href="wdf.wdfrequestmarkcancelable"><b>WdfRequestMarkCancelable</b></a> or <a href="wdf.wdfrequestmarkcancelableex"><b>WdfRequestMarkCancelableEx</b></a> to make an I/O request cancelable, there is potential for a synchronization problem. For example, your driver and device might perform device I/O operations asynchronously by means of <a href="wdf.evtinterruptisr"><i>EvtInterruptIsr</i></a> and <a href="wdf.evtinterruptdpc"><i>EvtInterruptDpc</i></a> callback functions, and both the <i>EvtInterruptDpc</i> and <a href="wdf.evtrequestcancel"><i>EvtRequestCancel</i></a> callback functions might contain calls to <a href="wdf.wdfrequestcomplete"><b>WdfRequestComplete</b></a>. </p>
<p>The driver must call <a href="wdf.wdfrequestcomplete"><b>WdfRequestComplete</b></a> only once, to either complete or cancel the request. But if the <a href="wdf.evtinterruptdpc"><i>EvtInterruptDpc</i></a> and <a href="wdf.evtrequestcancel"><i>EvtRequestCancel</i></a> callback functions are not synchronized with each other, the framework can call one while the other is executing. </p>
<p>Avoiding this problem is easy if your driver uses the framework's <a href="using_automatic_synchronization.htm">automatic synchronization</a>, because automatic synchronization ensures that the callback functions will be called one at a time. </p>
<p>If your driver does not use the framework's automatic synchronization, it can use <a href="using_framework_locks.htm">framework locks</a> to synchronize cancel and completion code.</p>
<p>Whether the driver uses framework's automatic synchronization or provides its own synchronization, the driver's <a href="wdf.evtrequestcancel"><i>EvtRequestCancel</i></a> callback function must call <a href="wdf.wdfrequestcomplete"><b>WdfRequestComplete</b></a> to cancel a request. The driver's <a href="wdf.evtinterruptdpc"><i>EvtInterruptDpc</i></a> callback function should call <a href="wdf.wdfrequestunmarkcancelable"><b>WdfRequestUnmarkCancelable</b></a> as follows:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>Status = WdfRequestUnmarkCancelable(Request);
if( Status != STATUS_CANCELLED ) {
    WdfRequestComplete(Request, RequestStatus);
    }</pre>
</td>
</tr>
</table></span></div>
<p>This code ensures that the driver does not call <a href="wdf.wdfrequestcomplete"><b>WdfRequestComplete</b></a> to complete the request if the driver has already called it to cancel the request.</p>
<p>For more information about the rules that your driver must follow when it calls <b>WdfRequestUnmarkCancelable</b>, see <a href="wdf.wdfrequestunmarkcancelable"><b>WdfRequestUnmarkCancelable</b></a>.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Synchronizing Cancel and Completion Code%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
