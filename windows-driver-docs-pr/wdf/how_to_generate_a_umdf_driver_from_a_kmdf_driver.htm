<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="This topic describes how to convert a Kernel-Mode Driver Framework (KMDF) driver into a User-Mode Driver Framework (UMDF) version 2.0 driver, and vice-versa."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>How to convert a KMDF driver to a UMDF 2.0 driver (and vice-versa)</title>

<meta name="MS-HAID" content="wdf.how_to_generate_a_umdf_driver_from_a_kmdf_driver"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.how_to_generate_a_umdf_driver_from_a_kmdf_driver"></a>How to convert a KMDF driver to a UMDF 2.0 driver (and vice-versa)</h1>
</div>
<p>This topic describes how to convert a Kernel-Mode Driver Framework (KMDF) driver into a User-Mode Driver Framework (UMDF) version 2.0 driver, and vice-versa.</p>
<h2><a id="use_vs"></a><a id="USE_VS"></a>Driver Conversion using Visual Studio</h2>
<ol>
<li>
<p>When switching from KMDF to UMDF, create an empty UMDF project in Visual Studio using the <b>User Mode Driver, Empty (UMDF 2.0)</b> project template. When switching from UMDF to KMDF, create an empty KMDF project in Visual Studio using the <b>Kernel Mode Driver, Empty (KMDF)</b> project template.</p>
<p>Visual Studio creates an empty driver project with the appropriate settings, along with an INF file targeted to the specified framework.</p>
</li>
<li>Copy the source code and header files from the previous driver into the new project.</li>
<li>
<p>Update your header files. For UMDF, include Windows.h. For KMDF, include Ntddk.h. Wdf.h is common to both KMDF and UMDF, so include it  in both types of drivers.</p>
<p>Optionally, use the <b>_KERNEL_MODE</b> preprocessor macro to add the right system header conditionally:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>#ifndef _KERNEL_MODE
// This is a user-mode driver
#include &lt;windows.h&gt;

#else
// This is a kernel-mode driver
#include &lt;ntddk.h&gt;
#define NTSTRSAFE_LIB
#include &lt;ntstrsafe.h&gt;
#endif

// This is a common WDF header (for both KMDF and UMDF)
#include &lt;wdf.h&gt; 
</pre>
</td>
</tr>
</table></span></div>
</li>
<li>
<p>Update the source code to either remove or conditionally compile (using the <b>_KERNEL_MODE</b> macro) any functionality that is not supported in the target driver model. For example:</p>
<ul>
<li>If your driver uses WPP tracing, update the <a href="devtest.wpp_init_tracing">WPP_INIT_TRACING</a> macro. This macro takes different parameters in user mode and kernel mode.<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>WPP_INIT_TRACING ( DriverObject, RegistryPath ); // KMDF
WPP_INIT_TRACING ( “&lt;MyDriverNameString&gt;” ); // UMDF
</pre>
</td>
</tr>
</table></span></div>
</li>
<li>If you are converting a KMDF driver that calls WDM routines such as <a href="kernel.exallocatepoolwithtag"><b>ExAllocatePoolWithTag</b></a>, replace these with the corresponding WDF methods, such as <a href="wdf.wdfmemorycreate"><b>WdfMemoryCreate</b></a>. Similarly, if you are converting a UMDF driver that calls user-mode functions, replace these with equivalent kernel-mode routines.</li>
<li>Some methods are supported only in KMDF, while others are supported only in UMDF.  For a list of all Windows Driver Frameworks (WDF) methods and their framework applicability, see <a href="wdf.summary_of_wdf_callbacks_and_methods">Summary of WDF Callbacks and Methods</a>.
</li>
</ul>
</li>
</ol>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20How to convert a KMDF driver to a UMDF 2.0 driver (and vice-versa)%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
