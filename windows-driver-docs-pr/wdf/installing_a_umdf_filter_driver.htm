<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="A filter driver can support a specific device or all devices in a setup class."/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Installing a UMDF Filter Driver</title>

<meta name="MS-HAID" content="wdf.installing_a_umdf_filter_driver"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.installing_a_umdf_filter_driver"></a>Installing a UMDF Filter Driver</h1>
</div>
<p>
<p>A filter driver can support a specific device or all devices in a setup class. A lower filter driver attaches below a device's function driver, while  an upper filter attaches above a device's function driver.</p>
<p>This topic describes how to install and configure a User-Mode Driver Framework (UMDF) device-specific (upper or lower) filter driver. You cannot use UMDF to write a class filter driver. This topic applies to both UMDF versions 1 and 2.</p>
<p>As you structure your device stack, keep in mind that the framework currently supports only one contiguous block of UMDF drivers per stack. Also, you cannot install UMDF version 1 and version 2 drivers in the same device stack.</p>
</p>
<p class="proch"><img src="../common/wedge.gif" alt=""/><b>How to install and configure your driver</b></p>
<ol>
<li>
<p>A UMDF 1 filter driver should call <a href="wdf.iwdfdeviceinitialize_setfilter"><b>IWDFDeviceInitialize::SetFilter</b></a> from the its <a href="wdf.idriverentry_ondeviceadd"><b>IDriverEntry::OnDeviceAdd</b></a> callback function. Starting in UMDF version 2, your driver instead calls <a href="wdf.wdffdoinitsetfilter"><b>WdfFdoInitSetFilter</b></a>.</p>
</li>
<li>
<p>In addition to any UMDF-specific directives your driver may specify, you must specify the <b>UmdfService</b> and <b>UmdfServiceOrder</b> directives. In this topic, we'll specify an upper filter driver:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>[&lt;mydriver&gt;_Install.NT.Wdf]
UmdfService=UMDFFunction,WUDFFuncDriver_Install
UmdfService=UMDFFilter,UMDFFilter_Install
UmdfServiceOrder=UMDFFunction,UMDFFilter</pre>
</td>
</tr>
</table></span></div>
<p>The drivers are added to the device stack in the order that they are listed in the <b>UmdfServiceOrder</b> entry. The first parameter specifies the lowest UMDF driver in the device stack.  To install a lower filter driver,  simply reverse the arguments for <b>UmdfServiceOrder</b>.</p>
<p>For more info about these and other UMDF-specific INF directives, see <a href="specifying_wdf_directives_in_inf_files.htm">Specifying WDF Directives in INF Files</a>.</p>
</li>
<li>
<p>If your driver's device stack contains only UMDF drivers, skip this step.</p>
<p>If your driver's device stack contains any drivers that are not UMDF, your INF file must include an <b>AddReg</b> section that specifies the reflector as an upper filter driver:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>[&lt;mydriver&gt;_Device_AddReg]
; Load the redirector as an upperfilter on this specific device.
; 0x00010008 - FLG_ADDREG_TYPE_MULTI_SZ | FLG_ADDREG_APPEND
HKR,,"UpperFilters",0x00010008,"WUDFRd" </pre>
</td>
</tr>
</table></span></div>
</li>
<li>
<p>After your driver is loaded as an upper filter, it is responsible for forwarding I/O requests to the next driver in the stack. To illustrate, consider a simple pass-through driver (UMDF version 1) that is above a KMDF function driver.</p>
<p>First, retrieve the interface of the default I/O target (next driver in the stack).  Then, format and send the request.  The simplest scenario would look like this:</p>
<div class="code"><span codelanguage=""><table>
<tr>
<th></th>
</tr>
<tr>
<td>
<pre>IWDFIoTarget * kmdfIoTarget = NULL;
    
    this-&gt;GetFxDevice()-&gt;GetDefaultIoTarget (&amp;kmdfIoTarget);

    Request-&gt;FormatUsingCurrentType();

    hr = Request-&gt;Send (
        kmdfIoTarget, 
        0,  // 0 Submits Asynchronous else use WDF_REQUEST_SEND_OPTION_SYNCHRONOUS
        0);</pre>
</td>
</tr>
</table></span></div>
</li>
</ol>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Installing a UMDF Filter Driver%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
