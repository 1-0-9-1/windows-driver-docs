<html xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:mssdk="winsdk" xmlns:script="urn:script" xmlns:build="urn:build" xmlns:MSHelp="http://msdn.microsoft.com/mshelp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="Description" content="Framework File Objects"/>
<meta name="MSHAttr" content="PreferredSiteName:MSDN"/>
<meta name="MSHAttr" content="PreferredLib:/library/windows/hardware"/>
<title>Framework File Objects</title>

<meta name="MS-HAID" content="Ch3_DFIoPackage_0bb9c0d5-ad3c-44b9-86a6-49f5f80700dd.xml"/>
<meta name="MS-HAID" content="kmdf.framework_file_objects"/>
<meta name="MS-HAID" content="wdf.framework_file_objects"/>


<link rel="STYLESHEET" type="text/css" HREF="../common/backsdk4.css"/>


</head>
<body>

<div id="mainSection">
<div class="clsServerSDKContent">
<h1><a id="wdf.framework_file_objects"></a>Framework File Objects</h1>
</div>
<h2><a id="ddk_using_framework_file_objects_df"></a><a id="DDK_USING_FRAMEWORK_FILE_OBJECTS_DF"></a></h2>
<p>When an application or a driver attempts to access a device, typically by creating or opening a file, the operating system sends a file creation request to the driver stack. When the application or driver has finished using the device, the system sends file cleanup and close requests to the driver stack. The <a href="wdf.wdf_request_type">request types</a> of these three requests are <b>WdfRequestTypeCreate</b>, <b>WdfRequestTypeCleanup</b>, and <b>WdfRequestTypeClose</b>, respectively.</p>
<p>Typically, unless your driver has called <a href="wdf.wdfdeviceinitsetexclusive"><b>WdfDeviceInitSetExclusive</b></a>, the driver must perform file-specific or other access-specific operations when it receives file creation, cleanup, and close requests, because multiple files can be open simultaneously or multiple applications can access the device simultaneously. The driver must therefore keep track of the I/O requests that are associated with each file or application.</p>
<p>The framework defines <i>framework file objects</i>, which represent an application or driver's means for accessing a device, such as a file, directory, volume, mail slot, named pipe, or the entire device. A file name can be associated with a file object, but the meaning of a file name is driver-specific. For more information about file names, see <a href="kernel.controlling_device_namespace_access">Controlling Device Namespace Access</a>.</p>
<p>If your driver must handle file operations, it must call <a href="wdf.wdfdeviceinitsetfileobjectconfig"><b>WdfDeviceInitSetFileObjectConfig</b></a> from within its <a href="wdf.evtdriverdeviceadd"><i>EvtDriverDeviceAdd</i></a> callback function. The <b>WdfDeviceInitSetFileObjectConfig</b> method receives a <a href="wdf.wdf_fileobject_config"><b>WDF_FILEOBJECT_CONFIG</b></a> structure as input. The driver uses this structure to register its <a href="wdf.evtdevicefilecreate"><i>EvtDeviceFileCreate</i></a>, <a href="wdf.evtfilecleanup"><i>EvtFileCleanup</i></a>, and <a href="wdf.evtfileclose"><i>EvtFileClose</i></a> callback functions and, optionally, to indicate whether the framework should create a framework file object each time that the driver receives a file creation request.</p>
<p>Most drivers that handle file operations store file-specific information in the framework file object's <a href="framework_object_context_space.htm">context space</a>. If your driver handles file operations but does not need to store information in a file object's context space, the framework does not have to create framework file objects for the driver. </p>
<h3><a id="creating_or_opening_a_file"></a><a id="CREATING_OR_OPENING_A_FILE"></a>Creating or Opening a File</h3>
<p>When the framework receives a file creation request for your function driver, it:</p>
<ol>
<li>
<p>Creates a framework file object that represents the file, unless the driver previously indicated that it does not need to use framework file objects. </p>
</li>
<li>
<p>Calls your driver's <a href="wdf.evtdevicefilecreate"><i>EvtDeviceFileCreate</i></a> callback function, if the driver has registered the callback function.</p>
</li>
</ol>
<p>The <a href="wdf.evtdevicefilecreate"><i>EvtDeviceFileCreate</i></a> callback function typically <a href="#obtaining_file_information">obtains information</a> about the file, such as its name and file object flags. The driver typically stores this information in the context space of the framework file object. </p>
<p>Instead of providing an <a href="wdf.evtdevicefilecreate"><i>EvtDeviceFileCreate</i></a> callback function, the driver can call <a href="wdf.wdfdeviceconfigurerequestdispatching"><b>WdfDeviceConfigureRequestDispatching</b></a> to set an I/O queue to receive all file creation requests (<b>WdfRequestTypeCreate</b> request type). The driver will subsequently receive file creation requests in the queue's <a href="wdf.evtiodefault"><i>EvtIoDefault</i></a> request handler. (An I/O queue cannot receive file creation requests if the <b>DefaultQueue</b> member of the queue's <a href="wdf.wdf_io_queue_config"><b>WDF_IO_QUEUE_CONFIG</b></a> structure is set to <b>TRUE</b>.)</p>
<p>If your driver does not provide an <a href="wdf.evtdevicefilecreate"><i>EvtDeviceFileCreate</i></a> callback function and does not set up an I/O queue to handle <b>WdfRequestTypeCreate</b>-typed I/O requests, the framework:</p>
<ul>
<li>
<p> Completes all file creation requests for the driver with a status value of STATUS_SUCCESS, if your driver is a function driver. </p>
</li>
<li>
<p> Forwards all file creation requests to the next-lower driver, if your driver is a filter driver.</p>
</li>
</ul>
<p>(To see how you can change this behavior, see the <b>AutoForwardCleanupClose</b> member of the <a href="wdf.wdf_fileobject_config"><b>WDF_FILEOBJECT_CONFIG</b></a> structure.) </p>
<div class="alert"><b>Note</b>    If your function driver does not provide any <a href="using_device_interfaces.htm">device interfaces</a> that applications can use to access the driver's devices, the driver must provide an <a href="wdf.evtdevicefilecreate"><i>EvtDeviceFileCreate</i></a> callback function that completes all file creation requests with a status value for which NT_SUCCESS(<i>status</i>) equals <b>FALSE</b>. Otherwise, a malicious application might attempt to access a device by using the name of the device's physical device object (PDO). (All PDOs have <a href="controlling_device_access_in_kmdf_drivers.htm#naming_device_objects_only_when_necessary">names</a>.)</div>
<div> </div>
<p>If a driver <a href="forwarding_i_o_requests.htm">forwards</a> a creation request to an I/O target, the driver must not subsequently <a href="completing_i_o_requests.htm">complete</a> the request with a failure status value unless the driver receives a failure status value from the I/O target. Otherwise, the lower drivers will not be notified that the creation request failed and might attempt to operate as if the file is open.</p>
<p>If a driver forwards a creation request to an I/O target, the driver cannot set the <a href="wdf.wdf_request_send_options_flags"><b>WDF_REQUEST_SEND_OPTION_SEND_AND_FORGET</b></a> flag if the framework has created a framework file object for the creation request. Therefore, the driver cannot set the WDF_REQUEST_SEND_OPTION_SEND_AND_FORGET flag for a creation request unless it also sets the <a href="wdf.wdf_fileobject_class"><b>WdfFileObjectNotRequired</b></a> flag. </p>
<p>Note that if a driver completes a creation request with an error status, the framework deletes the framework file object but does not call the driver's <a href="wdf.evtfilecleanup"><i>EvtFileCleanup</i></a> or <a href="wdf.evtfileclose"><i>EvtFileClose</i></a> callback functions. Therefore, if the driver allocates extra object-specific memory outside of the file object's context space it must provide an <a href="wdf.evtcleanupcallback"><i>EvtCleanupCallback</i></a> or <a href="wdf.evtdestroycallback"><i>EvtDestroyCallback</i></a> callback function that deletes the allocated memory.</p>
<p>For Windows Vista and later, file creation requests can be <a href="canceling_i_o_requests.htm">canceled</a>. Earlier versions of the Windows operating system do not support canceling file creation requests. </p>
<p>The system always creates a Windows Driver Model (WDM) file object for each creation request that comes from a user application. If a driver sends a creation request, it might not create a WDM file object for the request. Typically, the framework does not create a framework file object if a WDM file object is not present. However, if your driver has called <a href="wdf.wdfdeviceinitsetexclusive"><b>WdfDeviceInitSetExclusive</b></a> and if the driver has set <a href="wdf.wdf_fileobject_class"><b>WdfFileObjectWdfCannotUseFsContexts</b></a> in the <b>FileObjectClass</b> member of the <a href="wdf.wdf_fileobject_config"><b>WDF_FILEOBJECT_CONFIG</b></a> structure, the framework will create a framework file object even if a WDM file object does not exist.</p>
<h3><a id="obtaining_file_information"></a><a id="OBTAINING_FILE_INFORMATION"></a>
      Obtaining File Information</h3>
<p>The driver's <a href="wdf.evtdevicefilecreate"><i>EvtDeviceFileCreate</i></a> callback function can call one or more of the following object methods to obtain information about an application or driver's access to a device:</p>
<p></p>
<dl>
<dt><a id="_________WdfFileObjectGetFileName________"></a><a id="_________wdffileobjectgetfilename________"></a><a id="_________WDFFILEOBJECTGETFILENAME________"></a><a href="wdf.wdffileobjectgetfilename"><b>
        WdfFileObjectGetFileName
       </b></a></dt>
<dd>
<p>Returns the file name that is contained in a framework file object.</p>
</dd>
<dt><a id="_________WdfFileObjectGetFlags________"></a><a id="_________wdffileobjectgetflags________"></a><a id="_________WDFFILEOBJECTGETFLAGS________"></a><a href="wdf.wdffileobjectgetflags"><b>
        WdfFileObjectGetFlags
       </b></a></dt>
<dd>
<p>Returns the flags that are contained within a framework file object.</p>
</dd>
<dt><a id="_________WdfFileObjectWdmGetFileObject________"></a><a id="_________wdffileobjectwdmgetfileobject________"></a><a id="_________WDFFILEOBJECTWDMGETFILEOBJECT________"></a><a href="wdf.wdffileobjectwdmgetfileobject"><b>
        WdfFileObjectWdmGetFileObject
       </b></a></dt>
<dd>
<p>Returns the WDM file object that is associated with a framework file object.</p>
</dd>
<dt><a id="_________WdfRequestGetParameters________"></a><a id="_________wdfrequestgetparameters________"></a><a id="_________WDFREQUESTGETPARAMETERS________"></a><a href="wdf.wdfrequestgetparameters"><b>
        WdfRequestGetParameters
       </b></a></dt>
<dd>
<p>Retrieves the parameters that are associated with a framework request object. If the <a href="wdf.wdf_request_type">request type</a> is <b>WdfRequestTypeCreate</b>, the <b>Parameters.Create</b> member of the <a href="wdf.wdf_request_parameters"><b>WDF_REQUEST_PARAMETERS</b></a> structure contains information about the file creation request.</p>
</dd>
</dl>
<p>Typically, the driver stores file information in the framework file object's context space. When your driver obtains an I/O request from one if its I/O queues, the driver can call <a href="wdf.wdfrequestgetfileobject"><b>WdfRequestGetFileObject</b></a> to obtain a handle to the framework file object that is associated with the request. The driver can then retrieve the file information that it stored in the framework file object's context space.</p>
<p>Your driver can search an I/O queue for requests that are associated with a particular file by calling <a href="wdf.wdfioqueueretrieverequestbyfileobject"><b>WdfIoQueueRetrieveRequestByFileObject</b></a>.</p>
<p>If your driver has a pointer to a WDM <a href="kernel.device_object"><b>DEVICE_OBJECT</b></a> structure, the driver can call <a href="wdf.wdfdevicegetfileobject"><b>WdfDeviceGetFileObject</b></a> to obtain a handle to the framework file object that is associated with the WDM device object.</p>
<h3><a id="closing_a_file"></a><a id="CLOSING_A_FILE"></a>Closing a File</h3>
<p>When an application or another driver closes a file, the framework receives a cleanup request and a close request for your driver. The framework:</p>
<ol>
<li>
<p>Calls your driver's <a href="wdf.evtfilecleanup"><i>EvtFileCleanup</i></a> and <a href="wdf.evtfileclose"><i>EvtFileClose</i></a> callback functions, if the driver has registered these callback functions.</p>
</li>
<li>
<p>Deletes the framework file object that represents the file. </p>
</li>
</ol>
<p>The driver's <a href="wdf.evtfilecleanup"><i>EvtFileCleanup</i></a> and <a href="wdf.evtfileclose"><i>EvtFileClose</i></a> callback functions receive a handle to the framework file object. The driver can call <a href="wdf.wdffileobjectgetdevice"><b>WdfFileObjectGetDevice</b></a> to determine which framework  device object is associated with the framework file object.</p>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [wdf\wdf]:%20Framework File Objects%20 RELEASE:%20(3/15/2016)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
<p style="text-align:left;font-family:Arial,sanserif;font-size:100%;color:black">
&#x00a9;&#x00a0;2016 Microsoft. All rights reserved.</p>

</body>
</html>
